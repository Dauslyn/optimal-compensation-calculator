# Deep Review Report — Optimal Compensation Calculator

**Date:** 2026-02-20
**Scope:** Full codebase (`src/` — 83 source files, 36 test files)
**Categories Reviewed:** 13 of 14 (Migration Completeness skipped — no database)

---

## Summary

| Severity | Count |
|----------|-------|
| CRITICAL | 8 |
| IMPORTANT | 44 |
| MINOR | 20 |
| **Total** | **72** |

### Severity Breakdown by Category

| Category | CRITICAL | IMPORTANT | MINOR | Total |
|----------|----------|-----------|-------|-------|
| State Consistency | 0 | 6 | 1 | 7 |
| Semantic Alignment | 0 | 6 | 1 | 7 |
| Type Safety at Boundaries | 0 | 3 | 2 | 5 |
| Dead Code & Stale References | 3 | 9 | 5 | 17 |
| Error Path Correctness | 1 | 3 | 2 | 6 |
| Contract Mismatch | 0 | 4 | 2 | 6 |
| Routing Logic Gaps | 0 | 4 | 3 | 7 |
| Race Conditions | 0 | 3 | 1 | 4 |
| Null Propagation | 2 | 5 | 3 | 10 |
| Edge Case Inputs | 2 | 4 | 2 | 8 |
| Rollback Correctness | 0 | 2 | 2 | 4 |
| Configuration Drift | 0 | 5 | 2 | 7 |
| Test Fidelity | 1 | 7 | 3 | 11 |

---

## CRITICAL Findings

### C1. ScenarioBuilder imports non-existent monteCarlo exports
- **File:** `src/components/ScenarioBuilder.tsx:26`
- **Category:** Dead Code & Stale References
- **Description:** Imports `runMonteCarloSimulation`, `MonteCarloResults`, and `MonteCarloConfig` — none exist in `monteCarlo.ts`. The module exports `runMonteCarlo`, `MonteCarloResult`, and `MonteCarloOptions`. Confirmed by `App.tsx:12` comment: `// disabled — stale monteCarlo imports`.
- **Impact:** Entire Scenario Builder feature tree (4 components + `scenarios.ts`, ~1,100 lines) is dead code. Re-enabling the import would break the build.
- **Fix:** Delete `ScenarioBuilder.tsx`, `ScenarioCard.tsx`, `ScenarioComparison.tsx`, `MonteCarloResults.tsx`, `scenarios.ts`, and the dead "Scenarios" tab UI in `App.tsx`.

### C2. MonteCarloResults.tsx imports non-existent types
- **File:** `src/components/MonteCarloResults.tsx:9`
- **Category:** Dead Code & Stale References
- **Description:** Imports `MonteCarloResults` (plural) and `PercentileData` — neither exists. Component body references `.simulations`, `.config.numSimulations`, `.probabilityOfLoss` — all wrong field names.
- **Impact:** Component is structurally broken. Only unreachable because its parent (`ScenarioBuilder`) is disabled.
- **Fix:** Delete file (part of C1 cleanup).

### C3. "Scenarios" button renders empty div
- **File:** `src/App.tsx:24,36,195-230,308-311`
- **Category:** Dead Code & Stale References
- **Description:** A visible "Scenarios NEW" button in the header switches to a blank view. `ViewMode` type, `viewMode` state, and mode-switcher UI are all dead.
- **Impact:** Users can click a button that does nothing, with a misleading "NEW" badge.
- **Fix:** Remove `ViewMode` type, `viewMode` state, mode-switcher button, and empty div branch.

### C4. Empty `brackets` array crashes `getMarginalRateAtIncome`
- **File:** `src/lib/calculator.ts:86-87`
- **Category:** Null Propagation
- **Description:** `brackets[0].rate` accessed unconditionally. Empty bracket array (malformed province data) throws `TypeError`.
- **Impact:** Entire `calculateProjection` call crashes. Called 6+ times per year.
- **Fix:** Add `if (brackets.length === 0) return 0;` guard.

### C5. Empty `yearlyResults` array crashes summary computation
- **File:** `src/lib/calculator.ts:1792-1794`
- **Category:** Null Propagation / Edge Case Inputs
- **Description:** `yearlyResults[yearlyResults.length - 1].notionalAccounts.corporateInvestments` and `totalCompensation / yearlyResults.length` both crash/NaN on empty array.
- **Impact:** `TypeError` crash when `planningHorizon` resolves to 0 years.
- **Fix:** Guard with `if (yearlyResults.length === 0)` and return an early empty summary.

### C6. Monte Carlo worker has no try/catch — crash shows permanent spinner
- **File:** `src/workers/monteCarlo.worker.ts:19-23`
- **Category:** Error Path Correctness
- **Description:** Worker `onmessage` calls `runMonteCarlo()` with no error handling. If it throws, worker dies; UI shows permanent "Running Monte Carlo simulation..." spinner.
- **Impact:** Silent infinite spinner with no way to distinguish from a slow simulation.
- **Fix:** Wrap in try/catch, post `{ error: String(e) }` message. Add `workerError` state in `DetailsTab`.

### C7. `calculateCorporateTax` test is a mathematical tautology
- **File:** `src/lib/__tests__/corporateFlow.test.ts:86-91`
- **Category:** Test Fidelity
- **Description:** Computes `taxableBusinessIncome = corporateTaxOnActive / SBD_RATE`, then asserts `corporateTaxOnActive / taxableBusinessIncome ≈ SBD_RATE`. This is algebraically guaranteed for any nonzero value.
- **Impact:** Test passes even if the engine applies 26.5% instead of 12.2%.
- **Fix:** Pre-compute expected taxable income from known inputs: `knownTaxable = grossRevenue - salary - employerPayroll`, then assert `corporateTaxOnActive ≈ knownTaxable * SBD_RATE`.

### C8. Division by `(1 - rate)` where rate can approach 1.0
- **File:** `src/lib/accounts/accountOperations.ts:81,105,130,152,170`
- **Category:** Edge Case Inputs / Null Propagation
- **Description:** `grossDividendNeeded = remaining / (1 - effectiveRate)` at five call sites. `calculateEffectiveDividendRate` clamps at `Math.max(0, ...)` but not at 1.0. Rate >= 1.0 produces `Infinity`.
- **Impact:** `Infinity` dividend amount cascades through `afterTaxIncome`, corrupting all downstream year results.
- **Fix:** Clamp rate: `Math.max(0, Math.min(0.99, effectiveRate))` in `calculateEffectiveDividendRate`.

---

## IMPORTANT Findings

### I1. Share link serializes IPP expanded fields outside `ippMode` guard
- **File:** `src/lib/shareLink.ts:243-249`
- **Category:** State Consistency
- **Description:** IPP fields (`ippExistingFundBalance`, `ippLastValuationLiability`, etc.) are serialized unconditionally. A user who enters "existing IPP" data, switches back to "considering", and shares the link sends stale existing-IPP numbers.
- **Fix:** Only serialize existing-mode fields when `ippMode === 'existing'`.

### I2. Spouse IPP fields serialized outside `hasSpouse` guard
- **File:** `src/lib/shareLink.ts:251-258`
- **Category:** State Consistency
- **Description:** Spouse IPP expanded fields are serialized even when `hasSpouse` is false. Creates inconsistent deserialized state.
- **Fix:** Move spouse IPP serialization inside the `hasSpouse` block.

### I3. No localStorage migration for fields added in v3.4
- **File:** `src/lib/localStorage.ts:40-83`
- **Category:** State Consistency
- **Description:** `STORAGE_VERSION` never incremented. Pre-v3.4 saved objects lack `debts`, `ippMode`, etc. Returned as `undefined` without backfilling defaults.
- **Fix:** Add forward-migration: `if (data.inputs.debts === undefined) data.inputs.debts = []`.

### I4. Shared link overwrites user's localStorage save
- **File:** `src/components/InputFormClean.tsx:218-241`
- **Category:** State Consistency
- **Description:** Loading a share link triggers auto-save (500ms debounce), silently overwriting the user's own saved configuration.
- **Fix:** Skip auto-save when `initialInputs` changes from a share link load.

### I5. Blended return rate effect overrides share link's custom `investmentReturnRate`
- **File:** `src/components/InputFormClean.tsx:261-285`
- **Category:** State Consistency
- **Description:** The `useEffect` that syncs `investmentReturnRate` from allocation immediately overwrites any custom rate from a share link.
- **Fix:** Defer the sync until user interaction, or include `investmentReturnRate` in the dependency array.

### I6. Wizard inputs lost if localStorage fails
- **File:** `src/App.tsx:274-279`
- **Category:** State Consistency / Rollback Correctness
- **Description:** Wizard `onComplete` calls `saveInputsToStorage` (silently catches errors) then `markWizardComplete`. If save fails, wizard is marked complete but inputs are lost.
- **Fix:** Pass wizard inputs directly via `initialInputs` prop to `InputFormClean`.

### I7. Inline `spouseAge >= 71` vs canonical `mustConvertToRRIF(age)`
- **File:** `src/lib/calculator.ts:593` vs `src/lib/tax/rrif.ts:98`
- **Category:** Semantic Alignment
- **Description:** Spouse RRIF conversion uses inline literal `71` instead of `mustConvertToRRIF()`. Primary earner uses the canonical function.
- **Fix:** Replace `spouseAge >= 71` with `mustConvertToRRIF(spouseAge)`.

### I8. CG inclusion rate as magic number `0.5` in 3 locations
- **File:** `src/lib/calculator.ts:1104,1430` + `src/lib/accounts/accountOperations.ts:15`
- **Category:** Semantic Alignment
- **Description:** `investmentReturns.ts` defines `CG_INCLUSION_RATE = 0.50` but the other three files use literal `0.5`.
- **Fix:** Export `CG_INCLUSION_RATE` and import at all three sites.

### I9. Two parallel passive income grind implementations
- **File:** `src/lib/tax/corporateTax.ts:13-17` vs `src/lib/tax/passiveIncomeGrind.ts`
- **Category:** Semantic Alignment
- **Description:** `corporateTax.ts` has an inline grind implementation that diverges from the live `calculatePassiveIncomeGrind()`. The inline version doesn't net out deductible expenses.
- **Fix:** Delete `corporateTax.ts` (confirmed dead — see I33).

### I10. `rrspBalance`/`tfsaBalance` field names mean "contribution room" not "balance"
- **File:** `src/lib/types.ts:63-68` vs `src/lib/calculator.ts:381-384`
- **Category:** Semantic Alignment
- **Description:** Field names say "balance" but semantically store contribution room. The actual balances are `actualRRSPBalance`/`actualTFSABalance`.
- **Fix:** Rename to `rrspContributionRoom`/`tfsaContributionRoom` with share-link migration.

### I11. Dead `taxResult` and `otherIncomeTax` computations in retirement phase
- **File:** `src/lib/calculator.ts:1376-1392`
- **Category:** Semantic Alignment / Dead Code
- **Description:** Two full tax calculations computed but never read. `unifiedTax` is the only value used.
- **Fix:** Delete lines 1374-1392.

### I12. IPP limit fallback uses `||` vs `??` inconsistently
- **File:** `src/lib/tax/ipp.ts:59-62` vs `src/lib/tax/ipp.ts:298-303`
- **Category:** Semantic Alignment
- **Description:** `getMaxBenefitPerYear` uses `||` (falsy check), `calculateProjectedPension` uses `??` (nullish check). Would diverge if a zero-valued entry existed.
- **Fix:** Change `||` to `??` in `getMaxBenefitPerYear`.

### I13. `paymentFrequency` cast from string with no validation
- **File:** `src/lib/shareLink.ts:367`
- **Category:** Type Safety at Boundaries
- **Description:** `d.pf as PaymentFrequency` — invalid frequency string produces `NaN` in `aggregateDebts()`.
- **Fix:** Add `validatePaymentFrequency()` helper, default to `'monthly'`.

### I14. `ippMode`/`spouseIPPMode` cast from string with no validation
- **File:** `src/lib/shareLink.ts:372,380`
- **Category:** Type Safety at Boundaries
- **Description:** `compact.im as 'considering' | 'existing'` — garbage string passes `?? 'considering'` and silently enters wrong IPP mode.
- **Fix:** Add `validateIPPMode()` helper.

### I15. `Partial<YearlyResult>` immediately force-cast to `YearlyResult`
- **File:** `src/lib/calculator.ts:640,658,1258-1259`
- **Category:** Type Safety at Boundaries
- **Description:** `calculateRetirementYear` returns `Partial<YearlyResult>` but cast to full type. Missing fields are silently `undefined` in summary loops.
- **Fix:** Define a `RetirementYearResult` interface with exactly the populated fields, or fill all `YearlyResult` fields.

### I16. `ComparisonResult | null` passed to tabs expecting `ComparisonResult`
- **File:** `src/components/Summary.tsx:367-376`
- **Category:** Contract Mismatch
- **Description:** `comparison` is nullable but child tabs declare non-null props. Runtime guard exists but TypeScript doesn't narrow.
- **Fix:** Use `if (!comparison) return <LoadingUI />;` before the tab renders.

### I17. `STRATEGY_COLORS` missing `'current-setup'` key (ComparisonCharts)
- **File:** `src/components/charts/ComparisonCharts.tsx:21-25,169-171`
- **Category:** Contract Mismatch
- **Description:** 4th strategy "My Current Setup" has no color mapping. Lines render invisible.
- **Fix:** Add `'current-setup': '#a78bfa'` to `STRATEGY_COLORS`.

### I18. `STRATEGY_COLORS` missing `'current-setup'` key (DetailedCharts)
- **File:** `src/components/charts/DetailedCharts.tsx:22-26,259-261`
- **Category:** Contract Mismatch
- **Description:** Same issue as I17 but in `DetailedCharts.tsx`.
- **Fix:** Add `'current-setup'` key.

### I19. MonteCarloChart accesses `yearlyData[0].years` without optional chain
- **File:** `src/components/tabs/DetailsTab.tsx:97`
- **Category:** Contract Mismatch
- **Description:** Line 26 uses `yearlyData[0]?.years` (optional chain) but line 97 uses `yearlyData[0].years` (bare access). Inconsistent.
- **Fix:** Use `comparison.yearlyData[0]?.years.map(...) ?? []`.

### I20. `'fixed'` + no `fixedSalaryAmount` silently routes to `dynamic`
- **File:** `src/lib/calculator.ts:782-846`
- **Category:** Routing Logic Gaps
- **Description:** Primary salary dispatch combines `=== 'fixed' && fixedSalaryAmount` in one condition. Missing amount silently falls to `dynamic`.
- **Fix:** Separate the strategy check from the amount check; add explicit `else if (=== 'dynamic')` with warning `else`.

### I21. Same `'fixed'` routing gap in spouse salary dispatch
- **File:** `src/lib/calculator.ts:853-925`
- **Category:** Routing Logic Gaps
- **Fix:** Same as I20.

### I22. "My Current Setup" only generated for `'fixed'` strategy
- **File:** `src/lib/strategyComparison.ts:153-164`
- **Category:** Routing Logic Gaps
- **Description:** Users with `'dividends-only'` never see their current setup in Compare All tab.
- **Fix:** Extend condition to include `'dividends-only'`.

### I23. `getOntarioEHTRate` returns `brackets[i+1].rate` (off-by-one)
- **File:** `src/lib/tax/employerHealthTax.ts:51-58`
- **Category:** Routing Logic Gaps
- **Description:** Returns next bracket's rate instead of matched bracket's rate. Accidentally correct due to data layout but fragile.
- **Fix:** Refactor to return `brackets[i].rate` directly with a sentinel top bracket.

### I24. Worker `onmessage` has no unmount guard
- **File:** `src/components/tabs/DetailsTab.tsx:39-41`
- **Category:** Race Conditions
- **Description:** Rapid input changes can display Monte Carlo results from a cancelled simulation.
- **Fix:** Add `let cancelled = false` closure guard.

### I25. `handleCalculate` is `async` with no concurrency guard
- **File:** `src/App.tsx:103-112`
- **Category:** Race Conditions
- **Description:** Declared `async` but contains no `await`. Structural invitation for stuck `isCalculating` state if body ever becomes truly async.
- **Fix:** Remove `async` keyword.

### I26. Debounced save captures stale `formData` snapshot
- **File:** `src/components/InputFormClean.tsx:229-241`
- **Category:** Race Conditions
- **Description:** 500ms debounce can save pre-update value when blended-return effect updates `investmentReturnRate`.
- **Fix:** Use `formDataRef.current` in the timeout callback.

### I27. `investmentReturnRate` used without NaN guard
- **File:** `src/lib/calculator.ts:444-447`
- **Category:** Null Propagation
- **Description:** `balance *= (1 + inputs.investmentReturnRate)` — NaN from corrupt input poisons all balances.
- **Fix:** Assert `isFinite(investmentReturnRate)` at top of `calculateProjection`.

### I28. `depleteAccountsWithRates` divisor can be zero
- **File:** `src/lib/accounts/accountOperations.ts:81-82`
- **Category:** Null Propagation
- **Description:** `1 - eligibleEffectiveRate` when rate >= 1.0. (Related to C8.)
- **Fix:** Clamp rate to `Math.min(rate, 0.99)`.

### I29. Non-null assertion on `spouseCurrentAge` with no runtime guard
- **File:** `src/lib/calculator.ts:528-531`
- **Category:** Null Propagation
- **Description:** `inputs.spouseCurrentAge!` — value of 0 produces `birthYear: 2026`.
- **Fix:** Add `Math.max(18, inputs.spouseCurrentAge!)`.

### I30. `getTaxYearData(inputs.startingYear)` — undefined startingYear yields NaN YMPE
- **File:** `src/lib/strategyComparison.ts:116`
- **Category:** Null Propagation
- **Description:** Direct call with no fallback. Undefined `startingYear` produces NaN YMPE, corrupting all strategy results.
- **Fix:** `getTaxYearData(inputs.startingYear ?? new Date().getFullYear())`.

### I31. `handleCalculate` has no try/catch — calculator throw locks UI
- **File:** `src/App.tsx:103-112`
- **Category:** Error Path Correctness / Rollback Correctness
- **Description:** If `calculateProjection` throws, `setIsCalculating(false)` never runs. Permanent spinner.
- **Fix:** Wrap in try/catch/finally.

### I32. Unknown share link version falls through to `expandInputs`
- **File:** `src/lib/shareLink.ts:449-454`
- **Category:** Error Path Correctness
- **Description:** Version check logs warning but doesn't `return null`. Future version data decoded with wrong schema.
- **Fix:** `return null` for unrecognized versions.

### I33. `corporateTax.ts` — entire file is dead code
- **File:** `src/lib/tax/corporateTax.ts:6-42`
- **Category:** Dead Code
- **Description:** Both exports (`calculateCorporateTax`, `calculateRDTOHRefund`) have zero callers outside barrel re-exports.
- **Fix:** Delete file + remove re-exports.

### I34. `personalTax.ts` — 6 of 8 exports never called
- **File:** `src/lib/tax/personalTax.ts:9-258`
- **Category:** Dead Code
- **Description:** Functions use hardcoded Ontario-only 2025 rates. Superseded by `calculatePersonalTaxForYear()` in calculator.ts.
- **Fix:** Delete 6 unused exports. Keep `calculateOntarioSurtax` and `calculateOntarioHealthPremium` as private.

### I35. `compareStrategies()` in calculator.ts is dead code
- **File:** `src/lib/calculator.ts:1843-1869`
- **Category:** Dead Code
- **Description:** 30-line exported function superseded by `runStrategyComparison()`.
- **Fix:** Delete.

### I36. `totalTaxableIncome` local variable is dead
- **File:** `src/lib/calculator.ts:1371`
- **Category:** Dead Code
- **Description:** Declared but never read. Superseded by `allTaxableIncome`.
- **Fix:** Delete line 1371.

### I37. 4 dead functions in accountOperations.ts
- **File:** `src/lib/accounts/accountOperations.ts:218-292`
- **Category:** Dead Code
- **Description:** `addCapitalGainToCDA`, `addRDTOH`, `addToGRIP`, `calculateDividendCapacity` — zero callers. One is `@deprecated`.
- **Fix:** Delete + remove from barrel exports.

### I38. `taxRates.ts` — redundant barrel re-export
- **File:** `src/lib/taxRates.ts`
- **Category:** Dead Code
- **Description:** Single consumer (`accountOperations.ts`). Duplicates `tax/index.ts`.
- **Fix:** Update import to `'../tax/constants'`, delete file.

### I39. `notionalAccounts.ts` — redundant barrel re-export
- **File:** `src/lib/notionalAccounts.ts`
- **Category:** Dead Code
- **Description:** Single consumer (`calculator.ts`). Three-level re-export chain.
- **Fix:** Update import to `'./accounts'`, delete file.

### I40. IPP actuarial PV formula has no zero-rate guard
- **File:** `src/lib/tax/ipp.ts:104`
- **Category:** Edge Case Inputs
- **Description:** `(1 - Math.pow(1 + discountRate, -n)) / discountRate` — discountRate of 0 produces NaN.
- **Fix:** Guard: `if (discountRate === 0) return annuityYears`.

### I41. `planningHorizon: 0` causes NaN in Monte Carlo
- **File:** `src/lib/monteCarlo.ts:91`
- **Category:** Edge Case Inputs
- **Description:** `perYearReturns.reduce(...) / years` — 0/0 = NaN mean return.
- **Fix:** `if (years <= 0) return null`.

### I42. Share link clamp bounds disagree with validator
- **File:** `src/lib/shareLink.ts:318,319,328` vs `src/lib/validation.ts:90-122`
- **Category:** Configuration Drift
- **Description:** `startingYear` clamped to `[2026, 2050]` vs validator's `[currentYear-1, currentYear+1]`. `expectedInflationRate` clamped to `[0, 0.2]` vs validator's `[0, 0.1]`. `investmentReturnRate` clamped to `[-0.5, 0.5]` vs validator's `[0, 0.2]`.
- **Fix:** Align share link clamps to validator bounds.

### I43. Hardcoded `0.5017` corporate passive tax rate (Ontario-specific)
- **File:** `src/lib/calculator.ts:1131,1432`
- **Category:** Configuration Drift
- **Description:** Two hardcoded `0.5017` rates — Ontario-specific composite used for all provinces.
- **Fix:** Derive from `taxData.corporate.general` or look up province-specific rate.

### I44. Retirement drawdown uses hardcoded `$80,000` income estimate
- **File:** `src/lib/calculator.ts:1330-1331`
- **Category:** Configuration Drift
- **Description:** `calculateEffectiveDividendRate(taxData, 'eligible', 80000)` — doesn't use actual `retirementSpending`.
- **Fix:** Use `inputs.retirementSpending * 1.5` instead of `80000`.

### I45-I51. Test Fidelity findings (7 IMPORTANT)
- **I45.** `investmentReturns.test.ts:26-33` — eRDTOH/CDA tests use `result.x` to verify `result.y` (no independent anchor)
- **I46.** `investmentReturns.test.ts:67-74` — nRDTOH test mixes hardcoded `15000` with live `result.foreignIncome`
- **I47.** `corporateFlow.test.ts:432-443` — AAII test re-derives expected from same result object
- **I48.** `corporateFlow.test.ts:666-681` — eRDTOH conservation asserts only `>= 0` (any non-negative passes)
- **I49.** `estate.test.ts:77-90` — terminal RRIF tax asserts `>= 0` (0 would pass = no tax levied)
- **I50.** `estate.test.ts:118-129` — CDA wind-up test asserts only `netEstateValue > 0` (doesn't verify CDA tax-free treatment)
- **I51.** `corporateFlow.test.ts:760-773` — passive tax split re-derives expected from engine outputs

---

## MINOR Findings

### M1. Dashboard storage doesn't validate widget types against registry
- **File:** `src/components/dashboard/dashboardStorage.ts:35-43`
- **Category:** State Consistency

### M2. Ontario Health Premium — guard-before-loop vs loop-before-guard inconsistency
- **File:** `src/lib/tax/personalTax.ts:35-44`
- **Category:** Semantic Alignment

### M3. `STRATEGY_IDS` constant missing `'current-setup'`
- **File:** `src/components/dashboard/widgetRegistry.ts:35`
- **Category:** Semantic Alignment

### M4. `startingYear` clamp upper bound 2050 is too low
- **File:** `src/lib/shareLink.ts:318`
- **Category:** Type Safety at Boundaries

### M5. `retirementSuccessRate` hardcoded to 0.85 (not from Monte Carlo)
- **File:** `src/components/tabs/WinnerStrategyCard.tsx:51`
- **Category:** Type Safety at Boundaries / Contract Mismatch

### M6. `winner.bestOverall` redundantly re-resolved in RecommendedTab
- **File:** `src/components/tabs/RecommendedTab.tsx:17-19` vs `src/lib/strategyComparison.ts:222-228`
- **Category:** Contract Mismatch

### M7. RRIF rate lookup `?? 0` silently returns 0 for missing table entries
- **File:** `src/lib/tax/rrif.ts:77-81`
- **Category:** Routing Logic Gaps

### M8. CPP early/late adjustment `if/else if/else` is structurally fragile
- **File:** `src/lib/tax/cpp.ts:339-356`
- **Category:** Routing Logic Gaps

### M9. No validation for unrecognised `salaryStrategy` values
- **File:** `src/lib/validation.ts:220-228`
- **Category:** Routing Logic Gaps

### M10. `isFocused` ref race between `onBlur` and parent value sync
- **File:** `src/components/InputFormClean.tsx:74-82`
- **Category:** Race Conditions

### M11. `|| 0` instead of `?? 0` on RRSP/TFSA room
- **File:** `src/lib/calculator.ts:381-384`
- **Category:** Null Propagation

### M12. Optional chain on required `notionalAccounts` field
- **File:** `src/lib/monteCarlo.ts:107`
- **Category:** Null Propagation

### M13. `paymentFrequency` unvalidated cast (duplicate of I13)
- **File:** `src/lib/shareLink.ts:361-369`
- **Category:** Null Propagation

### M14. `getLastSavedTime` returns `Invalid Date` for missing `savedAt`
- **File:** `src/lib/localStorage.ts:111-123`
- **Category:** Error Path Correctness

### M15. `clearStoredInputs` error swallowed — reset may not persist
- **File:** `src/App.tsx:62-67` + `src/lib/localStorage.ts:89-95`
- **Category:** Rollback Correctness

### M16. Dashboard `handleReset` order — state cleared before storage
- **File:** `src/components/tabs/DashboardTab.tsx:131-134`
- **Category:** Rollback Correctness

### M17. `investmentReturnRate` default comment says 4.31% (actual: 7.25%)
- **File:** `src/lib/types.ts:69`
- **Category:** Configuration Drift

### M18. `retirementAge` clamp min 30 vs validator's `> currentAge`
- **File:** `src/lib/shareLink.ts:349`
- **Category:** Configuration Drift

### M19. `getTaxRatesForYear` — dead export in `tax/index.ts`
- **File:** `src/lib/tax/index.ts:13` + `src/lib/tax/constants.ts:127`
- **Category:** Dead Code

### M20. Test helpers use non-existent `inflationRate` field instead of `expectedInflationRate`
- **File:** `src/lib/__tests__/strategyComparison.test.ts:243` + `src/lib/__tests__/estate.test.ts:37`
- **Category:** Test Fidelity

---

## Clean Categories

- **Migration Completeness** — N/A (no database)

---

## Recommended Priority

### Immediate (before next release)
1. **C4 + C5 + C8** — Null/zero guards preventing crashes
2. **C6** — Worker error handling
3. **I31** — try/catch in `handleCalculate`
4. **I17 + I18** — Strategy colors for 4th slot
5. **I42** — Align share link clamp bounds to validator

### Short-term (next sprint)
1. **C1 + C2 + C3** — Clean up dead Scenario Builder code
2. **I1 + I2** — Share link IPP field guards
3. **I3** — localStorage migration
4. **I4** — Skip auto-save on share link load
5. **I13 + I14** — Share link validation for enums
6. **I33 + I34 + I35-I39** — Dead code cleanup (~400 lines removable)
7. **I43** — Province-specific passive corporate tax rate

### Medium-term
1. **I10** — Rename `rrspBalance`/`tfsaBalance` fields
2. **I8** — Centralize CG inclusion rate constant
3. **M5** — Wire real Monte Carlo success rate to narrative
4. **I45-I51** — Strengthen test assertions
5. **I44** — Retirement drawdown income estimate from actual spending
