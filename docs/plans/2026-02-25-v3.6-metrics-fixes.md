# v3.6 Metrics & Chart Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix the integrated tax rate math, remove meaningless metrics, surface missing data (OAS clawback, RRSP balance at retirement), extend charts through retirement, and fix the broken dashboard drag/drop.

**Architecture:** Most changes are in `calculator.ts` (new accumulators + fields on `ProjectionSummary`), `types.ts` (new type fields), and display components (`Summary.tsx`, `ActionPlanTable.tsx`, charts). No new modules needed.

**Tech Stack:** TypeScript, React 19, Recharts 3, Vitest

**Reference:** Integrated rate math validated against RSM Canada integration tables and TaxTips.ca DTC rates. Formula: `(personalTax + corpActiveTax) / (salary + grossDividends + corpActiveTax)` = total tax / pre-tax income extracted.

---

## Task 1: Fix integrated rate formula — accumulation phase

**Why:** Current denominator is `salary + grossDividends` (cash extracted). Correct denominator is `salary + grossDividends + corporateTaxOnActive` = pre-tax income consumed to pay the owner. Adding corp tax back to the denominator normalises the base to pre-tax income regardless of salary/dividend mix.

**Files:**
- Modify: `src/lib/calculator.ts` (around line 1831)
- Modify: `src/lib/__tests__/mathAudit.test.ts`

**Step 1: Update the formula**

Find this block in `calculator.ts`:
```typescript
const effectiveCompensationRate = accumCompensation > 0
  ? (accumPersonalTax + totalCorporateTaxOnActive) / accumCompensation
  : 0;
```

Replace with:
```typescript
// Denominator = salary + gross dividends + corp active tax = pre-tax income extracted.
// Adding corp tax back to denominator normalises to the same base regardless of salary/dividend mix:
//   Salary $500 + Corp tax $0 → denom $500 (corp deducts salary, pays $0 active tax)
//   Dividend $878 + Corp tax $122 → denom $1,000 (corp paid 12.2% SBD on $1,000)
// Reference: RSM Canada integration tables, TaxTips.ca
const accumPreTaxExtracted = accumCompensation + totalCorporateTaxOnActive;
const effectiveCompensationRate = accumPreTaxExtracted > 0
  ? (accumPersonalTax + totalCorporateTaxOnActive) / accumPreTaxExtracted
  : 0;
```

**Step 2: Run tests**
```bash
cd optimal-compensation-calculator && npx vitest run 2>&1 | tail -10
```
Expected: all 2012 pass (formula change is not directly tested; mathAudit tests use the blended rate not this metric).

**Step 3: Commit**
```bash
git add src/lib/calculator.ts
git commit -m "fix: correct integrated rate denominator to pre-tax income extracted"
```

---

## Task 2: Add retirement effective rate to ProjectionSummary

**Why:** User wants accumulation rate AND retirement rate shown separately.

**Files:**
- Modify: `src/lib/types.ts` (ProjectionSummary interface)
- Modify: `src/lib/calculator.ts` (summary loop + return)

**Step 1: Add field to ProjectionSummary in types.ts**

Find `ProjectionSummary` interface. Add after `effectiveCompensationRate`:
```typescript
retirementEffectiveRate: number;  // personal income tax / total retirement income (retirement years only)
```

**Step 2: Add accumulators in calculator.ts summary loop**

After the existing `accumPersonalTax` / `accumCompensation` declarations (around line 1751), add:
```typescript
let retirementPersonalTax = 0;
let retirementTotalIncome = 0;
```

Inside the loop, after the accumulation block (around line 1777), add:
```typescript
if (year.phase === 'retirement') {
  retirementPersonalTax += year.personalTax;
  retirementTotalIncome += year.retirement?.totalRetirementIncome ?? 0;
}
```

**Step 3: Compute and add to return**

After the `effectiveCompensationRate` line, add:
```typescript
const retirementEffectiveRate = retirementTotalIncome > 0
  ? retirementPersonalTax / retirementTotalIncome
  : 0;
```

Add `retirementEffectiveRate` to the summary return object (two places — the zero-return early exit and the main return).

**Step 4: Run tests**
```bash
npx vitest run 2>&1 | tail -10
```
Expected: all pass.

**Step 5: Commit**
```bash
git add src/lib/types.ts src/lib/calculator.ts
git commit -m "feat: add retirementEffectiveRate to ProjectionSummary"
```

---

## Task 3: Add RRSP balance at retirement to ProjectionSummary

**Why:** "RRSP Room Generated" is useless. Users want to know what their RRSP is worth at retirement.

**Files:**
- Modify: `src/lib/types.ts`
- Modify: `src/lib/calculator.ts`

**Step 1: Add field to ProjectionSummary**
```typescript
rrspBalanceAtRetirement: number;  // RRSP balance at start of first retirement year
```

**Step 2: Compute in summary loop**

After the existing accumulators block, add:
```typescript
let rrspBalanceAtRetirement = 0;
```

In the loop, find the first retirement year:
```typescript
if (year.phase === 'retirement' && rrspBalanceAtRetirement === 0 && year.balances) {
  rrspBalanceAtRetirement = year.balances.rrspBalance;
}
```

**Step 3: Add to return object** (both early-exit return and main return).

**Step 4: Run tests + commit**
```bash
npx vitest run 2>&1 | tail -5
git add src/lib/types.ts src/lib/calculator.ts
git commit -m "feat: add rrspBalanceAtRetirement to ProjectionSummary"
```

---

## Task 4: Add total OAS clawback to ProjectionSummary

**Why:** OAS clawback is already computed per year (`year.retirement.oasClawback`) but never surfaced in the UI.

**Files:**
- Modify: `src/lib/types.ts`
- Modify: `src/lib/calculator.ts`

**Step 1: Add field**
```typescript
totalOASClawback: number;  // lifetime OAS clawback across all retirement years
```

**Step 2: Add accumulator**
```typescript
let totalOASClawback = 0;
```

In loop:
```typescript
if (year.phase === 'retirement' && year.retirement) {
  totalOASClawback += year.retirement.oasClawback ?? 0;
}
```

**Step 3: Add to return, run tests, commit**
```bash
npx vitest run 2>&1 | tail -5
git add src/lib/types.ts src/lib/calculator.ts
git commit -m "feat: add totalOASClawback to ProjectionSummary"
```

---

## Task 5: Add outstanding debt balance to YearlyResult

**Why:** Wealth Over Time chart needs to subtract debt. Currently debt balance is not tracked per year.

**Files:**
- Modify: `src/lib/types.ts` (YearlyResult)
- Modify: `src/lib/calculator.ts` (accumulation year calc)
- Modify: `src/lib/accounts/accountOperations.ts` (if debt tracking lives there)

**Step 1: Add to YearlyResult in types.ts**
```typescript
outstandingDebt: number;  // total outstanding debt balance at end of this year
```

**Step 2: Find where debt paydown is computed in calculator.ts**

Search for `debtPaydown` in calculator.ts. The debt paydown is computed and returned on each year. We need to track the running outstanding balance.

Before the yearly results loop (accumulation phase), initialise:
```typescript
let runningDebtBalance = inputs.debts
  ? inputs.debts.reduce((sum, d) => sum + d.balance, 0)
  : (inputs.debtBalance ?? 0);
```

After computing `debtPaydown` for the year, subtract it and store:
```typescript
runningDebtBalance = Math.max(0, runningDebtBalance - debtPaydown);
// Then include in the year's return:
outstandingDebt: runningDebtBalance,
```

**Step 3: Run tests + commit**
```bash
npx vitest run 2>&1 | tail -5
git add src/lib/types.ts src/lib/calculator.ts
git commit -m "feat: track outstandingDebt per year in YearlyResult"
```

---

## Task 6: Update Summary.tsx — replace/remove/add stat cards

**Why:** Remove garbage metrics, add meaningful ones.

**Files:**
- Modify: `src/components/Summary.tsx`

**Changes to make:**

**6a — Replace RRSP Room Generated with RRSP Balance at Retirement**

Find the stat card:
```tsx
<div className="stat-card">
  <div className="stat-label">RRSP Room Generated</div>
  <div className="stat-value">{formatCurrency(summary.totalRRSPRoomGenerated)}</div>
  ...
</div>
```

Replace with:
```tsx
<div className="stat-card">
  <div className="stat-label">RRSP at Retirement</div>
  <div className="stat-value positive">{formatCurrency(summary.rrspBalanceAtRetirement)}</div>
  <div className="stat-hint">Estimated balance at age {inputs?.retirementAge ?? 65}</div>
</div>
```

**6b — Replace single Avg Integrated Tax Rate card with two cards**

Find the single centered `effectiveCompensationRate` card. Replace with a two-card row:
```tsx
<div className="flex gap-4 justify-center">
  <div className="text-center p-5 rounded-lg" style={{ background: 'rgba(5, 150, 105, 0.08)', minWidth: '200px' }}>
    <div className="text-xs mb-1" style={{ color: 'var(--text-secondary)' }}>Avg Tax Rate — Working Years</div>
    <div className="text-3xl font-bold" style={{ color: '#6ee7b7' }}>{formatPercent(summary.effectiveCompensationRate)}</div>
    <div className="text-xs mt-1" style={{ color: 'var(--text-muted)' }}>Income tax + corp tax on compensation</div>
  </div>
  {summary.retirementEffectiveRate > 0 && (
    <div className="text-center p-5 rounded-lg" style={{ background: 'rgba(5, 150, 105, 0.08)', minWidth: '200px' }}>
      <div className="text-xs mb-1" style={{ color: 'var(--text-secondary)' }}>Avg Tax Rate — Retirement</div>
      <div className="text-3xl font-bold" style={{ color: '#6ee7b7' }}>{formatPercent(summary.retirementEffectiveRate)}</div>
      <div className="text-xs mt-1" style={{ color: 'var(--text-muted)' }}>Personal income tax on retirement income</div>
    </div>
  )}
</div>
```

**6c — Add OAS Clawback where OAS is displayed**

In the Lifetime Summary row where `OAS Received` appears, add a clawback card alongside it:
```tsx
{summary.totalOASClawback > 0 && (
  <div className="stat-card">
    <div className="stat-label">OAS Clawback</div>
    <div className="stat-value" style={{ color: 'var(--color-warning)' }}>
      {formatCurrency(summary.totalOASClawback)}
    </div>
    <div className="stat-hint">Lifetime clawback on OAS income</div>
  </div>
)}
```

**6d — Remove IPP "RRSP Room Reduced (PA)" card**

In the IPP Impact section, find and delete:
```tsx
<div className="stat-card">
  <div className="stat-label">RRSP Room Reduced (PA)</div>
  ...
</div>
```

**Step: Run dev server, verify visually, then commit**
```bash
npx vitest run 2>&1 | tail -5
git add src/components/Summary.tsx
git commit -m "feat: update summary cards — retirement rate, RRSP at retirement, OAS clawback, remove PA"
```

---

## Task 7: Extend ActionPlanTable through retirement years

**Why:** Currently stops at retirement. Users and accountants need to see the full picture.

**Files:**
- Modify: `src/components/charts/ActionPlanTable.tsx`

**Step 1: Read ActionPlanTable.tsx** to see current structure and what data it receives.

**Step 2: Update column headers and row rendering**

The table currently shows: Year / Salary / Dividends / Total Comp / After-Tax / Corp Balance.

For retirement years, the meaningful columns differ. Use a conditional row layout:
- Accumulation years: Salary / Dividends / Total Comp / After-Tax / Corp Balance (same as now)
- Retirement years: CPP / OAS (net) / RRIF / Corp Div / Total Income / After-Tax / Corp Balance

Add a phase indicator column or section break row between accumulation and retirement.

**Step 3: Add section break row**
```tsx
// Detect phase transition
let lastPhase = '';
rows.map(year => {
  const isNewPhase = year.phase !== lastPhase;
  lastPhase = year.phase ?? 'accumulation';
  return (
    <>
      {isNewPhase && year.phase === 'retirement' && (
        <tr className="phase-break-row">
          <td colSpan={7} className="phase-label">— Retirement —</td>
        </tr>
      )}
      <tr>...</tr>
    </>
  );
})
```

**Step 4: Pass all yearlyResults (not just accumulation)**

Find where ActionPlanTable is rendered and ensure it receives the full `yearlyResults` array including retirement and estate phases (or at least retirement).

**Step 5: Commit**
```bash
git add src/components/charts/ActionPlanTable.tsx
git commit -m "feat: extend ActionPlanTable through retirement years"
```

---

## Task 8: Update Wealth Over Time chart to subtract debt

**Why:** Net worth = assets − liabilities. Showing assets without debt overstates wealth.

**Files:**
- Modify: `src/components/charts/LifetimeCharts.tsx` (BalanceDepletionChart)

**Step 1: Find the chart data transformation**

In `BalanceDepletionChart`, the chart data is built from `yearlyResults`. Find where balances are summed (RRSP + TFSA + Corp + IPP).

**Step 2: Subtract outstandingDebt**
```typescript
const totalWealth = (rrsp ?? 0) + (tfsa ?? 0) + (corp ?? 0) + (ipp ?? 0);
const netWealth = totalWealth - (year.outstandingDebt ?? 0);
```

Use `netWealth` instead of `totalWealth` as the chart value.

**Step 3: Update chart label**

Change "Total Wealth Over Lifetime" to "Net Worth Over Lifetime" or add a note "Assets minus outstanding debt."

**Step 4: Commit**
```bash
git add src/components/charts/LifetimeCharts.tsx
git commit -m "feat: subtract outstanding debt from wealth chart (net worth)"
```

---

## Task 9: Fix dashboard drag/drop (shelf → grid)

**Why:** Users can't drag widgets from the shelf into the dashboard grid.

**Files:**
- Modify: `src/components/dashboard/` — check `DashboardTab.tsx` or the main dashboard component

**Step 1: Find the onDragEnd handler**

Search for `onDragEnd` in the dashboard components. Find where it checks `over.id`.

**Step 2: Log what IDs are in play**

Add a temporary `console.log('dragEnd', { activeId: active.id, overId: over?.id })` to see what IDs are actually being used at runtime.

**Step 3: Fix the ID mismatch**

The likely issue: the drop zone is rendered with one ID (e.g. `'grid'`) but the handler checks for a different string (e.g. `'dashboard-grid'`). Make them match.

Also check: is `useDroppable` being used for the grid? If not, the shelf items may not have a valid drop target. If the grid items use `useSortable` but there's no `useDroppable` for the grid container itself, dropping from the shelf won't work.

Fix: ensure the grid container has `useDroppable({ id: 'dashboard-grid' })` and `onDragEnd` correctly handles `over.id === 'dashboard-grid'` as "add to grid" vs reordering existing items.

**Step 4: Test drag/drop in browser, then commit**
```bash
git add src/components/dashboard/
git commit -m "fix: dashboard shelf-to-grid drag/drop ID mismatch"
```

---

## Task 10: Final — TypeScript check, full test run, version bump

**Step 1: TypeScript compile**
```bash
npx tsc --noEmit
```
Fix any type errors introduced by new fields.

**Step 2: Full test run**
```bash
npx vitest run 2>&1 | tail -10
```
Expected: all tests pass (2012+).

**Step 3: Version bump and final commit**
```bash
git add -A
git commit -m "v3.6: metrics fixes, correct integrated rate, retirement rate split, net worth chart, dashboard drag/drop"
```

---

## References

- RSM Canada integration tables: https://rsmcanada.com/insights/services/business-tax-insights/canadian-tax-integration-of-private-company-income.html
- TaxTips.ca DTC rates by province: https://www.taxtips.ca/dtc/non-eligible-dividend-tax-credit.htm
- EY tax calculator (cross-check): https://www.eytaxcalculators.com/en/2025-personal-tax-calculator.html
- CRA Folio S3-F2-C2 (gross-up / DTC): https://www.canada.ca/en/revenue-agency/services/tax/technical-information/income-tax/income-tax-folios-index/series-3-property-investments-savings-plans/series-3-property-investments-savings-plan-folio-2-dividends/income-tax-folio-s3-f2-c2-taxable-dividends-corporations-resident-canada.html
