# v3.3 Bug Fixes + Spousal Retirement Age Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix two minor bugs (dead state key, Tooltip prop mismatch) and implement spousal retirement age so that a working spouse continues to contribute salary income during the primary's retirement years until the spouse's own retirement age.

**Architecture:** Three independent changes: (1) dead state cleanup in InputFormClean, (2) one-line prop fix in InputFormClean, (3) engine change in calculator.ts to gate spouse salary income by `spouseRetirementAge` during the retirement loop, with a test to verify the behaviour.

**Tech Stack:** React 19, TypeScript, Vitest (tests in `src/lib/__tests__/`)

---

### Task 1: Remove `advancedOpen.retirement` dead state key

**Files:**
- Modify: `src/components/InputFormClean.tsx:234-240`

**Step 1: Remove the unused key from initial state**

In `InputFormClean.tsx` find the `useState` initializer (around line 234):

```typescript
const [advancedOpen, setAdvancedOpen] = useState<Record<string, boolean>>({
  basic: false,
  accounts: false,
  portfolio: false,
  strategy: false,
  retirement: false,  // ← remove this line
});
```

Change it to:

```typescript
const [advancedOpen, setAdvancedOpen] = useState<Record<string, boolean>>({
  basic: false,
  accounts: false,
  portfolio: false,
  strategy: false,
});
```

**Step 2: Verify no references to `advancedOpen.retirement` exist**

Run:
```bash
grep -n "advancedOpen.retirement" src/components/InputFormClean.tsx
```
Expected: no output (zero matches).

**Step 3: Run full test suite to confirm no regressions**

```bash
npx vitest run
```
Expected: 1,888 tests pass.

**Step 4: Commit**

```bash
git add src/components/InputFormClean.tsx
git commit -m "fix: remove unused advancedOpen.retirement dead state key"
```

---

### Task 2: Fix Tooltip `text` prop → `content` prop on OAS Eligible checkbox

**Files:**
- Modify: `src/components/InputFormClean.tsx:597`

**Context:** The `Tooltip` component accepts a `content` prop (not `text`). Line 597 passes `text={...}`, which TypeScript silently ignores, causing the OAS Eligible tooltip to render empty.

**Step 1: Fix the prop name**

Find line 597 in `InputFormClean.tsx`:

```tsx
<Tooltip text={INPUT_TOOLTIPS.oasEligible} />
```

Change to:

```tsx
<Tooltip content={INPUT_TOOLTIPS.oasEligible} />
```

**Step 2: Verify no other `text=` usages exist on Tooltip**

```bash
grep -n "<Tooltip text=" src/components/InputFormClean.tsx
```
Expected: no output.

**Step 3: Run full test suite**

```bash
npx vitest run
```
Expected: 1,888 tests pass.

**Step 4: Commit**

```bash
git add src/components/InputFormClean.tsx
git commit -m "fix: correct Tooltip prop text= to content= on OAS eligible checkbox"
```

---

### Task 3: Implement spousal retirement age in engine (TDD — write test first)

**Files:**
- Modify: `src/lib/__tests__/retirementDrawdown.test.ts` (add test)
- Modify: `src/lib/calculator.ts` (implement)

**Background:** The retirement loop in `calculator.ts` starts when the *primary* reaches `retirementAge`. During those years, `householdExtraIncome` includes spouse CPP + OAS + RRIF. However, if the spouse hasn't yet reached *their* `spouseRetirementAge`, they're still working and their salary (`spouseRequiredIncome`) should also count as household income, reducing the amount drawn from corporate/RRSP/TFSA.

Currently `spouseRetirementAge` is defined in `UserInputs`, serialized in share links, shown in the form, and described in tooltips — but never read by the engine.

**Step 1: Write the failing test**

At the end of the `describe('spouse CPP/OAS in retirement')` block in `retirementDrawdown.test.ts`, add:

```typescript
it('spouse still working reduces drawdown until spouseRetirementAge', () => {
  // Primary retires at 65. Spouse is 5 years younger (age 50) and retires at 60.
  // So during primary's first 10 retirement years (age 65-74), spouse is 50-59 — still working.
  // After spouse hits 60, spouse salary stops.
  // Use large corporate balance, no RRSP/TFSA, high spending to force corporate drawdown each year.
  const baseInputs = createLifetimeInputs({
    currentAge: 45,
    retirementAge: 65,
    planningHorizon: 30, // age 45-75
    retirementSpending: 120000,
    corporateInvestmentBalance: 5000000,
    annualCorporateRetainedEarnings: 0,
    actualRRSPBalance: 0,
    actualTFSABalance: 0,
  });

  // Without spouse
  const noSpouseResult = calculateProjection(baseInputs);

  // With a working spouse who retires 10 years into primary's retirement
  const withSpouseInputs: UserInputs = {
    ...baseInputs,
    hasSpouse: true,
    spouseCurrentAge: 50,        // age 50 when primary is 45
    spouseRetirementAge: 60,     // spouse retires at 60 (primary is 75 — beyond our horizon, so use shorter)
    spouseCPPStartAge: 65,       // won't be reached in this window
    spouseSalaryStartAge: 22,
    spouseAverageHistoricalSalary: 60000,
    spouseOASEligible: false,    // no OAS in this window
    spouseOASStartAge: 65,
    spouseActualRRSPBalance: 0,
    spouseActualTFSABalance: 0,
    spouseRequiredIncome: 80000, // substantial salary that should reduce drawdown
  };
  const withSpouseResult = calculateProjection(withSpouseInputs);

  // During retirement years where spouse is still working (spouseAge < 60),
  // corporate drawdown should be less than without a spouse.
  const noSpouseRetYears = noSpouseResult.yearlyResults.filter(yr => yr.phase === 'retirement');
  const withSpouseRetYears = withSpouseResult.yearlyResults.filter(yr => yr.phase === 'retirement');

  // Find years where spouse is still working (spouseAge < spouseRetirementAge = 60)
  const spouseWorkingYears = withSpouseRetYears.filter(
    yr => yr.spouseAge !== undefined && yr.spouseAge < 60
  );
  expect(spouseWorkingYears.length).toBeGreaterThan(0); // must have some working years

  const noSpouseCorp = noSpouseRetYears
    .slice(0, spouseWorkingYears.length)
    .reduce((s, yr) => s + (yr.retirement?.corporateDividends ?? 0), 0);
  const withSpouseCorp = spouseWorkingYears
    .reduce((s, yr) => s + (yr.retirement?.corporateDividends ?? 0), 0);

  // Spouse salary should reduce how much the primary needs to draw from corporate
  expect(withSpouseCorp).toBeLessThan(noSpouseCorp);

  // After spouse retires (spouseAge >= 60), drawdown should be similar to no-spouse case
  // (CPP/OAS not yet in this window, so householdExtraIncome drops to 0 from spouse)
  const spouseRetiredYears = withSpouseRetYears.filter(
    yr => yr.spouseAge !== undefined && yr.spouseAge >= 60 && yr.spouseAge < 65
  );
  if (spouseRetiredYears.length > 0 && noSpouseRetYears.length >= spouseWorkingYears.length + spouseRetiredYears.length) {
    const noSpouseCorpAfter = noSpouseRetYears
      .slice(spouseWorkingYears.length, spouseWorkingYears.length + spouseRetiredYears.length)
      .reduce((s, yr) => s + (yr.retirement?.corporateDividends ?? 0), 0);
    const withSpouseCorpAfter = spouseRetiredYears
      .reduce((s, yr) => s + (yr.retirement?.corporateDividends ?? 0), 0);
    // After spouse retires (no CPP/OAS yet), drawdown should be close to base case (within 10%)
    expect(withSpouseCorpAfter).toBeGreaterThan(noSpouseCorpAfter * 0.9);
  }
});
```

**Step 2: Run the test to confirm it FAILS**

```bash
npx vitest run src/lib/__tests__/retirementDrawdown.test.ts
```
Expected: the new test FAILS (spouse salary has no effect currently).

**Step 3: Implement the fix in `calculator.ts`**

In the retirement loop (around line 552–608), after the `spouseAge` is computed, add spouse salary income. The complete change is:

After this existing block (around line 555):
```typescript
// Spouse age for this year
const spouseAge = (inputs.hasSpouse && inputs.spouseCurrentAge !== undefined)
  ? inputs.spouseCurrentAge + yearIndex
  : undefined;
```

Add immediately below it:
```typescript
// Spouse salary income: continues until spouse reaches spouseRetirementAge
// Falls back to primary retirementAge if spouseRetirementAge not set
const spouseRetirementAge = inputs.spouseRetirementAge ?? inputs.retirementAge;
const spouseStillWorking =
  inputs.hasSpouse &&
  spouseAge !== undefined &&
  inputs.spouseRequiredIncome !== undefined &&
  inputs.spouseRequiredIncome > 0 &&
  spouseAge < spouseRetirementAge;
const spouseSalaryIncome = spouseStillWorking
  ? inflateAmount(inputs.spouseRequiredIncome!, yearIndex, inflationRate)
  : 0;
```

Then find the `householdExtraIncome` line (around line 608):
```typescript
householdExtraIncome: spouseCPPIncome + spouseOASResult.netOAS + spouseRRIFWithdrawal,
```

Change it to:
```typescript
householdExtraIncome: spouseSalaryIncome + spouseCPPIncome + spouseOASResult.netOAS + spouseRRIFWithdrawal,
```

**Step 4: Run the test again to confirm it PASSES**

```bash
npx vitest run src/lib/__tests__/retirementDrawdown.test.ts
```
Expected: all tests in this file PASS including the new one.

**Step 5: Run the full test suite to confirm no regressions**

```bash
npx vitest run
```
Expected: all 1,888 + 1 new = 1,889 tests pass.

**Step 6: Run TypeScript check**

```bash
npx tsc -p tsconfig.app.json --noEmit
```
Expected: no errors.

**Step 7: Commit**

```bash
git add src/lib/__tests__/retirementDrawdown.test.ts src/lib/calculator.ts
git commit -m "feat: spouse salary income continues until spouseRetirementAge during primary retirement"
```

---

### Task 4: Update MEMORY.md

**Files:**
- Modify: `/Users/home/.claude/projects/-Users-home-Documents-Vibe-Coding-Project-Ideas-Optimal-Compensation-Calculator/memory/MEMORY.md`

Add a v3.3 entry under PR History and update Known Remaining Gaps to remove the three items now resolved.

**Step 1: Add v3.3 section to MEMORY.md**

Under `## PR History`, add:
```
- v3.3 — No PR; committed directly to main. Fixes: Tooltip prop mismatch (OAS eligible), dead advancedOpen.retirement state key. Feature: spouseRetirementAge now gates spouse salary income during primary's retirement loop.
```

Under `## Key Patterns` or a new `## Known Remaining Gaps` section, note:
```
- Salary deferral / bonus averaging: parked for post-launch
- advancedOpen.retirement unused key: FIXED in v3.3
- Tooltip text= prop mismatch on OAS eligible: FIXED in v3.3
- spouseRetirementAge not read by engine: FIXED in v3.3
```

**Step 2: Commit memory update** (memory dir is outside the repo — no git commit needed here; just save the file)

---

## Summary

| Task | File(s) | Lines changed | Risk |
|------|---------|---------------|------|
| 1. Remove dead state key | InputFormClean.tsx | 1 line removed | Zero |
| 2. Fix Tooltip prop | InputFormClean.tsx | 1 line changed | Zero |
| 3. Spouse retirement age | calculator.ts + test | ~10 lines added | Low |
| 4. Update MEMORY.md | memory/MEMORY.md | ~5 lines | Zero |

Run `npx vitest run` after each task. All 1,888 existing tests must remain green throughout.
