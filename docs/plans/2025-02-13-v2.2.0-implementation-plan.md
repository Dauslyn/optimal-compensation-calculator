# v2.2.0 Visualization & Tabbed Interface Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Transform results interface into tabbed workspace with Recharts visualizations, after-tax wealth scenarios, and progressive disclosure UX.

**Architecture:** Refactor Summary.tsx into 4 tabs (Recommended, Compare All, Details, Export). Add after-tax wealth calculation to strategyComparison.ts. Create 11 new Recharts visualizations across tabs. Maintain existing test coverage while adding new calculations.

**Tech Stack:** React 19, TypeScript 5.9, Recharts 3, Tailwind CSS v4

**Design Document:** `docs/plans/2025-02-13-v2.2.0-visualization-design.md`

---

## Phase 1: Data Layer (After-Tax Wealth Calculation)

### Task 1.1: Add Top Provincial Rate Helper

**Files:**
- Modify: `src/lib/tax/provinces.ts`
- Test: `src/lib/__tests__/provinces.test.ts`

**Step 1: Write the failing test**

```typescript
// In src/lib/__tests__/provinces.test.ts
import { getTopProvincialRate } from '../tax/provinces';

describe('getTopProvincialRate', () => {
  test('returns top combined federal + provincial rate for Ontario', () => {
    expect(getTopProvincialRate('ON')).toBeCloseTo(0.5353, 4);
  });

  test('returns top rate for Quebec', () => {
    expect(getTopProvincialRate('QC')).toBeCloseTo(0.5353, 4);
  });

  test('returns top rate for BC', () => {
    expect(getTopProvincialRate('BC')).toBeCloseTo(0.5353, 4);
  });

  test('returns top rate for Alberta', () => {
    expect(getTopProvincialRate('AB')).toBeCloseTo(0.48, 4);
  });
});
```

**Step 2: Run test to verify it fails**

Run: `npm test -- provinces.test.ts`
Expected: FAIL with "getTopProvincialRate is not exported"

**Step 3: Write minimal implementation**

```typescript
// In src/lib/tax/provinces.ts, add export:

/**
 * Get the top combined federal + provincial marginal tax rate
 * for a given province (2025 rates).
 */
export function getTopProvincialRate(province: ProvinceCode): number {
  const topBrackets: Record<ProvinceCode, number> = {
    AB: 0.48,      // 33% federal + 15% AB
    BC: 0.5353,    // 33% federal + 20.5% BC
    MB: 0.5040,    // 33% federal + 17.4% MB
    NB: 0.5353,    // 33% federal + 19.5% NB
    NL: 0.5480,    // 33% federal + 21.8% NL
    NS: 0.54,      // 33% federal + 21% NS
    NT: 0.4740,    // 33% federal + 14.05% NT
    NU: 0.4405,    // 33% federal + 11.5% NU
    ON: 0.5353,    // 33% federal + 20.53% ON
    PE: 0.5167,    // 33% federal + 18.37% PE
    QC: 0.5353,    // 33% federal + 25.75% QC (with abatement)
    SK: 0.4775,    // 33% federal + 14.5% SK
    YT: 0.4800,    // 33% federal + 15% YT
  };
  return topBrackets[province];
}
```

**Step 4: Run test to verify it passes**

Run: `npm test -- provinces.test.ts`
Expected: PASS (all 4 tests)

**Step 5: Commit**

```bash
git add src/lib/tax/provinces.ts src/lib/__tests__/provinces.test.ts
git commit -m "feat: add getTopProvincialRate helper for after-tax wealth calculation

- Returns top combined federal + provincial marginal rate by province
- Used to calculate worst-case after-tax wealth scenarios
- 2025 tax rates"
```

---

### Task 1.2: Add After-Tax Wealth Types

**Files:**
- Modify: `src/lib/strategyComparison.ts`

**Step 1: Add TypeScript interfaces**

```typescript
// In src/lib/strategyComparison.ts, add after existing imports:

export interface AfterTaxWealthScenarios {
  atCurrentRate: number;      // Using average marginal rate from projection
  atLowerRate: number;        // Marginal - 10%, min 20%
  atTopRate: number;          // Top provincial rate
  assumptions: {
    currentRRSPWithdrawalRate: number;
    lowerRRSPWithdrawalRate: number;
    topRRSPWithdrawalRate: number;
    corpLiquidationRate: number;  // Fixed at 40% (non-eligible dividends)
  };
}

export interface StrategyResult {
  id: string;
  label: string;
  description: string;
  summary: ProjectionSummary;
  diff: {
    taxSavings: number;
    balanceDifference: number;
    rrspRoomDifference: number;
  };
  trueAfterTaxWealth: AfterTaxWealthScenarios;  // NEW
}
```

**Step 2: No test needed (types only)**

**Step 3: Commit**

```bash
git add src/lib/strategyComparison.ts
git commit -m "feat: add AfterTaxWealthScenarios type to StrategyResult

- Three scenarios: current/lower/top marginal rate
- Includes assumptions for transparency
- Part of after-tax wealth calculation feature"
```

---

### Task 1.3: Implement After-Tax Wealth Calculation

**Files:**
- Modify: `src/lib/strategyComparison.ts`
- Test: `src/lib/__tests__/afterTaxWealth.test.ts` (NEW)

**Step 1: Write the failing test**

```typescript
// Create src/lib/__tests__/afterTaxWealth.test.ts

import { calculateAfterTaxWealth } from '../strategyComparison';
import type { ProjectionSummary } from '../types';

describe('calculateAfterTaxWealth', () => {
  const mockSummary: ProjectionSummary = {
    totalTax: 100000,
    totalSalary: 300000,
    totalDividends: 200000,
    totalCompensation: 500000,
    totalAfterTaxIncome: 400000,
    effectiveTaxRate: 0.32,
    averageAnnualIncome: 100000,
    finalCorporateBalance: 250000,
    totalRRSPRoomGenerated: 50000,
    tfsaContributions: 30000,
    rrspBalance: 80000,
    yearlyResults: [],
  };

  test('calculates after-tax wealth at current rate', () => {
    const result = calculateAfterTaxWealth(mockSummary, 'ON', 0.35);

    // baseWealth = 400k (after-tax income) + 30k (TFSA) = 430k
    // RRSP = 80k * (1 - 0.35) = 52k
    // Corp = 250k * (1 - 0.40) = 150k
    // Total = 430k + 52k + 150k = 632k
    expect(result.atCurrentRate).toBeCloseTo(632000, 0);
  });

  test('calculates after-tax wealth at lower rate (marginal - 10%)', () => {
    const result = calculateAfterTaxWealth(mockSummary, 'ON', 0.35);

    // Lower rate = 0.35 - 0.10 = 0.25
    // baseWealth = 430k
    // RRSP = 80k * (1 - 0.25) = 60k
    // Corp = 150k
    // Total = 430k + 60k + 150k = 640k
    expect(result.atLowerRate).toBeCloseTo(640000, 0);
  });

  test('calculates after-tax wealth at top provincial rate', () => {
    const result = calculateAfterTaxWealth(mockSummary, 'ON', 0.35);

    // Top ON rate = 0.5353
    // baseWealth = 430k
    // RRSP = 80k * (1 - 0.5353) = 37,176
    // Corp = 150k
    // Total = 430k + 37,176 + 150k = 617,176
    expect(result.atTopRate).toBeCloseTo(617176, 0);
  });

  test('lower rate floors at 20% minimum', () => {
    const result = calculateAfterTaxWealth(mockSummary, 'AB', 0.22);

    // Lower would be 0.12, but floors at 0.20
    expect(result.assumptions.lowerRRSPWithdrawalRate).toBe(0.20);
  });

  test('returns correct assumptions object', () => {
    const result = calculateAfterTaxWealth(mockSummary, 'BC', 0.40);

    expect(result.assumptions.currentRRSPWithdrawalRate).toBe(0.40);
    expect(result.assumptions.lowerRRSPWithdrawalRate).toBe(0.30);
    expect(result.assumptions.topRRSPWithdrawalRate).toBeCloseTo(0.5353, 4);
    expect(result.assumptions.corpLiquidationRate).toBe(0.40);
  });
});
```

**Step 2: Run test to verify it fails**

Run: `npm test -- afterTaxWealth.test.ts`
Expected: FAIL with "calculateAfterTaxWealth is not exported"

**Step 3: Write implementation**

```typescript
// In src/lib/strategyComparison.ts, add import and function:

import { getTopProvincialRate } from './tax/provinces';

/**
 * Calculate true after-tax wealth if all assets were liquidated at end of planning horizon.
 * Shows 3 scenarios based on RRSP withdrawal tax rates.
 */
export function calculateAfterTaxWealth(
  summary: ProjectionSummary,
  province: ProvinceCode,
  averageMarginalRate: number
): AfterTaxWealthScenarios {
  const topRate = getTopProvincialRate(province);
  const lowerRate = Math.max(averageMarginalRate - 0.10, 0.20);
  const corpLiquidationRate = 0.40; // Conservative estimate (non-eligible dividends)

  // Base wealth = already taxed income + tax-free TFSA
  const baseWealth = summary.totalAfterTaxIncome + summary.tfsaContributions;

  return {
    atCurrentRate: baseWealth +
      (summary.rrspBalance * (1 - averageMarginalRate)) +
      (summary.finalCorporateBalance * (1 - corpLiquidationRate)),

    atLowerRate: baseWealth +
      (summary.rrspBalance * (1 - lowerRate)) +
      (summary.finalCorporateBalance * (1 - corpLiquidationRate)),

    atTopRate: baseWealth +
      (summary.rrspBalance * (1 - topRate)) +
      (summary.finalCorporateBalance * (1 - corpLiquidationRate)),

    assumptions: {
      currentRRSPWithdrawalRate: averageMarginalRate,
      lowerRRSPWithdrawalRate: lowerRate,
      topRRSPWithdrawalRate: topRate,
      corpLiquidationRate,
    },
  };
}
```

**Step 4: Run test to verify it passes**

Run: `npm test -- afterTaxWealth.test.ts`
Expected: PASS (all 5 tests)

**Step 5: Commit**

```bash
git add src/lib/strategyComparison.ts src/lib/__tests__/afterTaxWealth.test.ts
git commit -m "feat: implement after-tax wealth calculation with 3 scenarios

- Calculates true after-tax value of RRSP + corporate assets
- Three scenarios: current marginal rate, lower rate, top rate
- Conservative assumptions: 40% corp liquidation rate
- Floors lower rate at 20% minimum
- Tested with 5 comprehensive unit tests"
```

---

### Task 1.4: Integrate After-Tax Wealth into Strategy Comparison

**Files:**
- Modify: `src/lib/strategyComparison.ts`
- Test: `src/lib/__tests__/strategyComparison.test.ts` (update existing)

**Step 1: Write the failing test**

```typescript
// In src/lib/__tests__/strategyComparison.test.ts, add new test:

test('includes after-tax wealth scenarios for all strategies', () => {
  const result = runStrategyComparison(mockInputs);

  result.strategies.forEach(strategy => {
    expect(strategy.trueAfterTaxWealth).toBeDefined();
    expect(strategy.trueAfterTaxWealth.atCurrentRate).toBeGreaterThan(0);
    expect(strategy.trueAfterTaxWealth.atLowerRate).toBeGreaterThan(0);
    expect(strategy.trueAfterTaxWealth.atTopRate).toBeGreaterThan(0);
    expect(strategy.trueAfterTaxWealth.assumptions).toBeDefined();

    // Lower rate should give higher after-tax wealth than top rate
    expect(strategy.trueAfterTaxWealth.atLowerRate).toBeGreaterThan(
      strategy.trueAfterTaxWealth.atTopRate
    );
  });
});
```

**Step 2: Run test to verify it fails**

Run: `npm test -- strategyComparison.test.ts`
Expected: FAIL with "trueAfterTaxWealth is undefined"

**Step 3: Modify runStrategyComparison to calculate after-tax wealth**

```typescript
// In src/lib/strategyComparison.ts, update runStrategyComparison:

export function runStrategyComparison(inputs: UserInputs): ComparisonResult {
  const ympe = getTaxYearData(inputs.startingYear).cpp.ympe;

  // ... existing strategy definitions ...

  // Run each strategy and calculate average marginal rate
  const strategies: Array<{
    id: string;
    label: string;
    description: string;
    summary: ProjectionSummary;
    averageMarginalRate: number;
  }> = strategyDefs.map(def => {
    const summary = calculateProjection({ ...inputs, ...def.inputOverrides });

    // Calculate average marginal rate from yearly results
    const totalIncome = summary.yearlyResults.reduce((sum, year) => sum + year.salary + year.dividends.grossDividends, 0);
    const totalTax = summary.totalTax;
    const averageMarginalRate = totalIncome > 0 ? totalTax / totalIncome : 0.35;

    return {
      id: def.id,
      label: def.label,
      description: def.description,
      summary,
      averageMarginalRate,
    };
  });

  // ... existing winner determination ...

  // Compute diffs and after-tax wealth relative to best-overall
  const results: StrategyResult[] = strategies.map(s => ({
    id: s.id,
    label: s.label,
    description: s.description,
    summary: s.summary,
    diff: {
      taxSavings: bestOverallStrategy.summary.totalTax - s.summary.totalTax,
      balanceDifference: s.summary.finalCorporateBalance - bestOverallStrategy.summary.finalCorporateBalance,
      rrspRoomDifference: s.summary.totalRRSPRoomGenerated - bestOverallStrategy.summary.totalRRSPRoomGenerated,
    },
    trueAfterTaxWealth: calculateAfterTaxWealth(s.summary, inputs.province, s.averageMarginalRate),
  }));

  return {
    strategies: results,
    winner: {
      lowestTax: lowestTaxStrategy.id,
      highestBalance: highestBalanceStrategy.id,
      bestOverall: bestOverallStrategy.id,
    },
  };
}
```

**Step 4: Run test to verify it passes**

Run: `npm test -- strategyComparison.test.ts`
Expected: PASS (including new test)

**Step 5: Commit**

```bash
git add src/lib/strategyComparison.ts src/lib/__tests__/strategyComparison.test.ts
git commit -m "feat: integrate after-tax wealth into strategy comparison

- Each StrategyResult now includes trueAfterTaxWealth
- Calculates average marginal rate per strategy
- Test verifies all 3 strategies have after-tax wealth data
- Lower rate scenarios consistently show higher wealth"
```

---

### Task 1.5: Add Year-by-Year Data to ComparisonResult

**Files:**
- Modify: `src/lib/strategyComparison.ts`
- Test: `src/lib/__tests__/strategyComparison.test.ts`

**Step 1: Write the failing test**

```typescript
// In src/lib/__tests__/strategyComparison.test.ts:

test('includes year-by-year data for all strategies', () => {
  const result = runStrategyComparison(mockInputs);

  expect(result.yearlyData).toBeDefined();
  expect(result.yearlyData).toHaveLength(3);

  result.yearlyData.forEach(strategyYearly => {
    expect(strategyYearly.strategyId).toBeDefined();
    expect(strategyYearly.years).toBeDefined();
    expect(strategyYearly.years.length).toBe(mockInputs.planningHorizon);
  });
});
```

**Step 2: Run test to verify it fails**

Run: `npm test -- strategyComparison.test.ts`
Expected: FAIL with "yearlyData is undefined"

**Step 3: Update ComparisonResult interface and implementation**

```typescript
// In src/lib/strategyComparison.ts, update interface:

export interface ComparisonResult {
  strategies: StrategyResult[];
  winner: {
    lowestTax: string;
    highestBalance: string;
    bestOverall: string;
  };
  yearlyData: {
    strategyId: string;
    years: YearlyResult[];
  }[];
}

// In runStrategyComparison, update return:

  return {
    strategies: results,
    winner: {
      lowestTax: lowestTaxStrategy.id,
      highestBalance: highestBalanceStrategy.id,
      bestOverall: bestOverallStrategy.id,
    },
    yearlyData: strategies.map(s => ({
      strategyId: s.id,
      years: s.summary.yearlyResults,
    })),
  };
```

**Step 4: Run test to verify it passes**

Run: `npm test -- strategyComparison.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add src/lib/strategyComparison.ts src/lib/__tests__/strategyComparison.test.ts
git commit -m "feat: add year-by-year data to ComparisonResult

- Enables multi-line charts to plot strategy trajectories
- yearlyData array with strategyId + years
- Tested for correct structure and length"
```

---

## Phase 2: Tab Navigation Component

### Task 2.1: Create TabNavigation Component

**Files:**
- Create: `src/components/tabs/TabNavigation.tsx`
- Create: `src/components/tabs/TabNavigation.test.tsx` (optional, skip for now)

**Step 1: Create component file**

```typescript
// Create src/components/tabs/TabNavigation.tsx

import { memo } from 'react';

export type TabId = 'recommended' | 'compare' | 'details' | 'export';

interface Tab {
  id: TabId;
  label: string;
  icon?: string;
}

interface TabNavigationProps {
  activeTab: TabId;
  onTabChange: (tabId: TabId) => void;
  disabled?: boolean;
}

const TABS: Tab[] = [
  { id: 'recommended', label: 'Recommended', icon: '✓' },
  { id: 'compare', label: 'Compare All' },
  { id: 'details', label: 'Details' },
  { id: 'export', label: 'Export' },
];

export const TabNavigation = memo(function TabNavigation({
  activeTab,
  onTabChange,
  disabled = false,
}: TabNavigationProps) {
  return (
    <div className="border-b" style={{ borderColor: 'var(--border-subtle)' }}>
      {/* Desktop: Horizontal tabs */}
      <div className="hidden md:flex gap-1">
        {TABS.map(tab => (
          <button
            key={tab.id}
            onClick={() => !disabled && onTabChange(tab.id)}
            disabled={disabled}
            className={`
              px-4 py-3 text-sm font-medium transition-colors
              border-b-2 -mb-px
              ${activeTab === tab.id
                ? 'border-current'
                : 'border-transparent hover:border-gray-300'
              }
            `}
            style={{
              color: activeTab === tab.id ? 'var(--accent-primary)' : 'var(--text-muted)',
              cursor: disabled ? 'not-allowed' : 'pointer',
              opacity: disabled ? 0.5 : 1,
            }}
          >
            {tab.icon && <span className="mr-1.5">{tab.icon}</span>}
            {tab.label}
          </button>
        ))}
      </div>

      {/* Mobile: Dropdown */}
      <div className="md:hidden">
        <select
          value={activeTab}
          onChange={(e) => !disabled && onTabChange(e.target.value as TabId)}
          disabled={disabled}
          className="w-full px-4 py-3 text-sm font-medium"
          style={{
            background: 'var(--bg-base)',
            color: 'var(--text-primary)',
            border: 'none',
            cursor: disabled ? 'not-allowed' : 'pointer',
          }}
        >
          {TABS.map(tab => (
            <option key={tab.id} value={tab.id}>
              {tab.icon ? `${tab.icon} ${tab.label}` : tab.label}
            </option>
          ))}
        </select>
      </div>
    </div>
  );
});
```

**Step 2: Create directory**

```bash
mkdir -p src/components/tabs
```

**Step 3: Verify no TypeScript errors**

Run: `npm run build`
Expected: No errors in TabNavigation.tsx

**Step 4: Commit**

```bash
git add src/components/tabs/TabNavigation.tsx
git commit -m "feat: create TabNavigation component

- Horizontal tabs on desktop, dropdown on mobile
- Active tab indicator with accent color
- Disabled state for loading
- Keyboard accessible"
```

---

## Phase 3: Tab 1 - Recommended Components

### Task 3.1: Create AfterTaxWealthTable Component

**Files:**
- Create: `src/components/charts/AfterTaxWealthTable.tsx`

**Step 1: Create component**

```typescript
// Create src/components/charts/AfterTaxWealthTable.tsx

import { memo } from 'react';
import type { ComparisonResult } from '../../lib/strategyComparison';
import { formatCurrency } from '../../lib/formatters';

interface AfterTaxWealthTableProps {
  comparison: ComparisonResult;
}

export const AfterTaxWealthTable = memo(function AfterTaxWealthTable({
  comparison,
}: AfterTaxWealthTableProps) {
  const { strategies } = comparison;

  // Find best in each scenario
  const bestAtLower = strategies.reduce((best, s) =>
    s.trueAfterTaxWealth.atLowerRate > best.trueAfterTaxWealth.atLowerRate ? s : best
  );
  const bestAtCurrent = strategies.reduce((best, s) =>
    s.trueAfterTaxWealth.atCurrentRate > best.trueAfterTaxWealth.atCurrentRate ? s : best
  );
  const bestAtTop = strategies.reduce((best, s) =>
    s.trueAfterTaxWealth.atTopRate > best.trueAfterTaxWealth.atTopRate ? s : best
  );

  const assumptions = strategies[0].trueAfterTaxWealth.assumptions;

  return (
    <div className="space-y-3">
      <div>
        <h4 className="font-semibold text-base mb-2" style={{ color: 'var(--text-primary)' }}>
          After-Tax Wealth Reality Check
        </h4>
        <p className="text-sm" style={{ color: 'var(--text-muted)' }}>
          If you liquidated everything at end of planning horizon:
        </p>
      </div>

      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr style={{ borderBottom: '2px solid var(--border-subtle)' }}>
              <th className="text-left py-2 px-3" style={{ color: 'var(--text-secondary)' }}>
                Scenario
              </th>
              {strategies.map(strategy => (
                <th key={strategy.id} className="text-right py-2 px-3" style={{ color: 'var(--text-secondary)' }}>
                  {strategy.label}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>
              <td className="py-3 px-3" style={{ color: 'var(--text-primary)' }}>
                Retire at lower rate ({Math.round(assumptions.lowerRRSPWithdrawalRate * 100)}%)
              </td>
              {strategies.map(strategy => (
                <td key={strategy.id} className="text-right py-3 px-3 font-medium" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(strategy.trueAfterTaxWealth.atLowerRate)}
                  {strategy.id === bestAtLower.id && (
                    <span className="ml-2 text-xs" style={{ color: 'var(--accent-success)' }}>✓</span>
                  )}
                </td>
              ))}
            </tr>
            <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>
              <td className="py-3 px-3" style={{ color: 'var(--text-primary)' }}>
                Retire at current rate ({Math.round(assumptions.currentRRSPWithdrawalRate * 100)}%)
              </td>
              {strategies.map(strategy => (
                <td key={strategy.id} className="text-right py-3 px-3 font-medium" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(strategy.trueAfterTaxWealth.atCurrentRate)}
                  {strategy.id === bestAtCurrent.id && (
                    <span className="ml-2 text-xs" style={{ color: 'var(--accent-success)' }}>✓</span>
                  )}
                </td>
              ))}
            </tr>
            <tr>
              <td className="py-3 px-3" style={{ color: 'var(--text-primary)' }}>
                Retire at top rate ({Math.round(assumptions.topRRSPWithdrawalRate * 100)}%)
              </td>
              {strategies.map(strategy => (
                <td key={strategy.id} className="text-right py-3 px-3 font-medium" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(strategy.trueAfterTaxWealth.atTopRate)}
                  {strategy.id === bestAtTop.id && (
                    <span className="ml-2 text-xs" style={{ color: 'var(--accent-success)' }}>✓</span>
                  )}
                </td>
              ))}
            </tr>
          </tbody>
        </table>
      </div>

      <p className="text-xs" style={{ color: 'var(--text-muted)' }}>
        <strong>✓ = Best in this scenario.</strong> Lower retirement rates are more realistic if you reduce income in retirement.
        Assumes RRSP withdrawals at shown rates and {Math.round(assumptions.corpLiquidationRate * 100)}% tax on corporate liquidation.
      </p>
    </div>
  );
});
```

**Step 2: Create charts directory**

```bash
mkdir -p src/components/charts
```

**Step 3: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 4: Commit**

```bash
git add src/components/charts/AfterTaxWealthTable.tsx
git commit -m "feat: create AfterTaxWealthTable component

- Shows 3 withdrawal scenarios (lower, current, top rate)
- Compares all strategies side-by-side
- Highlights best in each scenario with checkmark
- Explains assumptions in footer"
```

---

### Task 3.2: Create ActionPlanTable Component

**Files:**
- Create: `src/components/charts/ActionPlanTable.tsx`

**Step 1: Create component**

```typescript
// Create src/components/charts/ActionPlanTable.tsx

import { memo } from 'react';
import type { YearlyResult } from '../../lib/types';
import { formatCurrency } from '../../lib/formatters';

interface ActionPlanTableProps {
  yearlyResults: YearlyResult[];
}

function formatCompact(value: number): string {
  if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
  if (value >= 1000) return `$${Math.round(value / 1000)}K`;
  return formatCurrency(value);
}

export const ActionPlanTable = memo(function ActionPlanTable({
  yearlyResults,
}: ActionPlanTableProps) {
  return (
    <div className="space-y-2">
      <h4 className="font-semibold text-base" style={{ color: 'var(--text-primary)' }}>
        Your Action Plan
      </h4>

      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr style={{ borderBottom: '2px solid var(--border-subtle)' }}>
              <th className="text-left py-2 px-3" style={{ color: 'var(--text-secondary)' }}>Year</th>
              <th className="text-right py-2 px-3" style={{ color: 'var(--text-secondary)' }}>Salary</th>
              <th className="text-right py-2 px-3" style={{ color: 'var(--text-secondary)' }}>Dividends</th>
              <th className="text-right py-2 px-3" style={{ color: 'var(--text-secondary)' }}>Total Comp</th>
              <th className="text-right py-2 px-3" style={{ color: 'var(--text-secondary)' }}>After-Tax</th>
              <th className="text-right py-2 px-3" style={{ color: 'var(--text-secondary)' }}>Corp Balance</th>
            </tr>
          </thead>
          <tbody>
            {yearlyResults.map((year, idx) => (
              <tr
                key={year.year}
                style={{
                  borderBottom: idx < yearlyResults.length - 1 ? '1px solid var(--border-subtle)' : undefined,
                }}
              >
                <td className="py-2 px-3 font-medium" style={{ color: 'var(--text-primary)' }}>
                  {year.year}
                </td>
                <td className="text-right py-2 px-3" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(year.salary)}
                </td>
                <td className="text-right py-2 px-3" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(year.dividends.grossDividends)}
                </td>
                <td className="text-right py-2 px-3 font-medium" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(year.salary + year.dividends.grossDividends)}
                </td>
                <td className="text-right py-2 px-3" style={{ color: 'var(--text-primary)' }}>
                  {formatCurrency(year.afterTaxIncome)}
                </td>
                <td className="text-right py-2 px-3 font-medium" style={{ color: 'var(--text-primary)' }}>
                  {formatCompact(year.notionalAccounts.corporateInvestments)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
});
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/charts/ActionPlanTable.tsx
git commit -m "feat: create ActionPlanTable component

- Year-by-year breakdown of salary, dividends, outcomes
- Compact notation for corporate balance (247K vs $247,000)
- Shows what to do each year for recommended strategy"
```

---

### Task 3.3: Create WinnerStrategyCard Component

**Files:**
- Create: `src/components/tabs/WinnerStrategyCard.tsx`

**Step 1: Create component**

```typescript
// Create src/components/tabs/WinnerStrategyCard.tsx

import { memo } from 'react';
import type { ComparisonResult } from '../../lib/strategyComparison';
import { formatCurrency } from '../../lib/formatters';

interface WinnerStrategyCardProps {
  comparison: ComparisonResult;
}

const STRATEGY_COLORS: Record<string, string> = {
  'salary-at-ympe': '#3b82f6',
  'dividends-only': '#10b981',
  'dynamic': '#f59e0b',
};

export const WinnerStrategyCard = memo(function WinnerStrategyCard({
  comparison,
}: WinnerStrategyCardProps) {
  const winner = comparison.strategies.find(s => s.id === comparison.winner.bestOverall);
  if (!winner) return null;

  const others = comparison.strategies.filter(s => s.id !== winner.id);
  const color = STRATEGY_COLORS[winner.id] || '#6b7280';

  return (
    <div
      className="rounded-xl p-6"
      style={{
        background: 'var(--bg-elevated)',
        border: `2px solid ${color}`,
        boxShadow: `0 0 20px ${color}33`,
      }}
    >
      {/* Badge */}
      <div className="text-center mb-4">
        <div
          className="inline-block px-4 py-1.5 rounded-full text-sm font-bold text-white mb-3"
          style={{ background: color }}
        >
          RECOMMENDED
        </div>
        <div>
          <div
            className="inline-block w-3 h-3 rounded-full mr-2"
            style={{ background: color }}
          />
          <span className="font-semibold text-lg" style={{ color: 'var(--text-primary)' }}>
            {winner.label}
          </span>
        </div>
        <p className="text-sm mt-1" style={{ color: 'var(--text-muted)' }}>
          {winner.description}
        </p>
      </div>

      {/* Why this wins */}
      <div className="space-y-2">
        <h4 className="font-semibold text-sm" style={{ color: 'var(--text-primary)' }}>
          Why this strategy wins:
        </h4>
        <ul className="space-y-1.5 text-sm" style={{ color: 'var(--text-secondary)' }}>
          <li>
            • Lowest total tax: {formatCurrency(winner.summary.totalTax)}
            {' '}(vs{' '}
            {others.map((s, idx) => (
              <span key={s.id}>
                {formatCurrency(s.summary.totalTax)}
                {idx < others.length - 1 ? ' & ' : ''}
              </span>
            ))}
            )
          </li>
          <li>
            • Best wealth accumulation: {formatCurrency(winner.summary.finalCorporateBalance + winner.summary.rrspBalance)}
            {' '}total assets (vs{' '}
            {others.map((s, idx) => (
              <span key={s.id}>
                {formatCurrency(s.summary.finalCorporateBalance + s.summary.rrspBalance)}
                {idx < others.length - 1 ? ' & ' : ''}
              </span>
            ))}
            )
          </li>
          <li>
            • Optimal balance of tax efficiency + flexibility
          </li>
        </ul>
      </div>
    </div>
  );
});
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/tabs/WinnerStrategyCard.tsx
git commit -m "feat: create WinnerStrategyCard component

- Shows single winner strategy with RECOMMENDED badge
- Explains why it wins with 3 bullet comparisons
- Styled with strategy color and glow effect"
```

---

### Task 3.4: Create RecommendedTab Component

**Files:**
- Create: `src/components/tabs/RecommendedTab.tsx`

**Step 1: Create component**

```typescript
// Create src/components/tabs/RecommendedTab.tsx

import { memo } from 'react';
import type { ComparisonResult } from '../../lib/strategyComparison';
import { WinnerStrategyCard } from './WinnerStrategyCard';
import { AfterTaxWealthTable } from '../charts/AfterTaxWealthTable';
import { ActionPlanTable } from '../charts/ActionPlanTable';
import { Chart } from '../Chart';

interface RecommendedTabProps {
  comparison: ComparisonResult;
}

export const RecommendedTab = memo(function RecommendedTab({
  comparison,
}: RecommendedTabProps) {
  const winner = comparison.strategies.find(s => s.id === comparison.winner.bestOverall);
  if (!winner) return null;

  return (
    <div className="space-y-6">
      {/* Winner Card */}
      <WinnerStrategyCard comparison={comparison} />

      {/* After-Tax Wealth Table */}
      <AfterTaxWealthTable comparison={comparison} />

      {/* Action Plan */}
      <ActionPlanTable yearlyResults={winner.summary.yearlyResults} />

      {/* Corporate Balance Chart (winner only) */}
      <div>
        <h4 className="font-semibold text-base mb-3" style={{ color: 'var(--text-primary)' }}>
          Corporate Balance Projection
        </h4>
        <Chart results={winner.summary.yearlyResults} />
      </div>
    </div>
  );
});
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/tabs/RecommendedTab.tsx
git commit -m "feat: create RecommendedTab component

- Combines WinnerStrategyCard, AfterTaxWealthTable, ActionPlanTable
- Shows corporate balance chart for winner only
- Default tab - answers 'what should I do?' in 10 seconds"
```

---

## Phase 4: Tab 2 - Compare All Components

### Task 4.1: Create ComparisonCharts Component (TotalTaxBarChart)

**Files:**
- Create: `src/components/charts/ComparisonCharts.tsx`

**Step 1: Create component with first chart**

```typescript
// Create src/components/charts/ComparisonCharts.tsx

import { memo } from 'react';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';
import type { ComparisonResult } from '../../lib/strategyComparison';
import { formatCurrency } from '../../lib/formatters';

interface ComparisonChartsProps {
  comparison: ComparisonResult;
}

const STRATEGY_COLORS: Record<string, string> = {
  'salary-at-ympe': '#3b82f6',
  'dividends-only': '#10b981',
  'dynamic': '#f59e0b',
};

const CustomTooltip = ({ active, payload }: any) => {
  if (!active || !payload || !payload.length) return null;

  return (
    <div
      style={{
        background: 'rgba(22, 22, 30, 0.95)',
        backdropFilter: 'blur(12px)',
        border: '1px solid rgba(255,255,255,0.1)',
        borderRadius: '12px',
        padding: '12px 16px',
      }}
    >
      <p style={{ fontWeight: 600, marginBottom: 8, color: 'rgba(255,255,255,0.9)' }}>
        {payload[0]?.payload?.name}
      </p>
      <p style={{ color: 'rgba(255,255,255,0.95)', fontSize: '13px' }}>
        {formatCurrency(payload[0]?.value)}
      </p>
    </div>
  );
};

export const ComparisonCharts = memo(function ComparisonCharts({
  comparison,
}: ComparisonChartsProps) {
  const formatCompact = (value: number): string => {
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value}`;
  };

  // Total Tax Bar Chart Data
  const taxData = comparison.strategies.map(s => ({
    name: s.label,
    value: s.summary.totalTax,
    fill: STRATEGY_COLORS[s.id] || '#6b7280',
  }));

  return (
    <div className="space-y-6">
      {/* Total Tax Comparison */}
      <div className="glass-card p-5">
        <h3 className="font-semibold mb-5" style={{ color: 'var(--text-primary)' }}>
          Total Tax Comparison
        </h3>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={taxData} barCategoryGap="30%">
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" vertical={false} />
            <XAxis
              dataKey="name"
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
            />
            <YAxis
              tickFormatter={formatCompact}
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
              width={60}
            />
            <Tooltip content={<CustomTooltip />} />
            <Bar dataKey="value" radius={[8, 8, 0, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
});
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/charts/ComparisonCharts.tsx
git commit -m "feat: create ComparisonCharts with TotalTaxBarChart

- Grouped bar chart comparing total tax across 3 strategies
- Strategy-specific colors from STRATEGY_COLORS
- Custom tooltip with dark styling
- First of 3 charts for Compare All tab"
```

---

### Task 4.2: Add CorporateBalanceLineChart to ComparisonCharts

**Files:**
- Modify: `src/components/charts/ComparisonCharts.tsx`

**Step 1: Add multi-line chart**

```typescript
// In src/components/charts/ComparisonCharts.tsx, add imports:

import {
  BarChart,
  Bar,
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';

// In ComparisonCharts component, after taxData:

  // Corporate Balance Line Chart Data
  const maxYears = Math.max(...comparison.yearlyData.map(s => s.years.length));
  const balanceData = Array.from({ length: maxYears }, (_, idx) => {
    const dataPoint: any = { year: `Y${idx + 1}` };
    comparison.yearlyData.forEach(strategyYearly => {
      const strategy = comparison.strategies.find(s => s.id === strategyYearly.strategyId);
      if (strategy && strategyYearly.years[idx]) {
        dataPoint[strategy.label] = strategyYearly.years[idx].notionalAccounts.corporateInvestments;
      }
    });
    return dataPoint;
  });

  const winner = comparison.strategies.find(s => s.id === comparison.winner.bestOverall);

  // In return, add after Total Tax chart:

      {/* Corporate Balance Over Time */}
      <div className="glass-card p-5">
        <h3 className="font-semibold mb-5" style={{ color: 'var(--text-primary)' }}>
          Corporate Balance Over Time
        </h3>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={balanceData}>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" vertical={false} />
            <XAxis
              dataKey="year"
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
            />
            <YAxis
              tickFormatter={formatCompact}
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
              width={60}
            />
            <Tooltip content={<CustomTooltip />} />
            <Legend
              iconType="line"
              iconSize={12}
              wrapperStyle={{ fontSize: '11px', paddingTop: '16px' }}
            />
            {comparison.strategies.map(strategy => (
              <Line
                key={strategy.id}
                type="monotone"
                dataKey={strategy.label}
                stroke={STRATEGY_COLORS[strategy.id]}
                strokeWidth={strategy.id === winner?.id ? 3 : 2}
                dot={{ fill: STRATEGY_COLORS[strategy.id], r: 3, strokeWidth: 0 }}
              />
            ))}
          </LineChart>
        </ResponsiveContainer>
      </div>
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/charts/ComparisonCharts.tsx
git commit -m "feat: add CorporateBalanceLineChart to ComparisonCharts

- Multi-line chart showing all 3 strategies over time
- Winner line highlighted with strokeWidth=3
- Shows trajectory comparison across planning horizon"
```

---

### Task 4.3: Add CumulativeTaxLineChart to ComparisonCharts

**Files:**
- Modify: `src/components/charts/ComparisonCharts.tsx`

**Step 1: Add cumulative tax chart**

```typescript
// In ComparisonCharts component, after balanceData:

  // Cumulative Tax Line Chart Data
  const cumulativeTaxData = Array.from({ length: maxYears }, (_, idx) => {
    const dataPoint: any = { year: `Y${idx + 1}` };
    comparison.yearlyData.forEach(strategyYearly => {
      const strategy = comparison.strategies.find(s => s.id === strategyYearly.strategyId);
      if (strategy) {
        // Sum tax up to and including this year
        const cumulativeTax = strategyYearly.years
          .slice(0, idx + 1)
          .reduce((sum, year) => sum + year.totalTax, 0);
        dataPoint[strategy.label] = cumulativeTax;
      }
    });
    return dataPoint;
  });

  // In return, add after Corporate Balance chart:

      {/* Cumulative Tax Paid Over Time */}
      <div className="glass-card p-5">
        <h3 className="font-semibold mb-5" style={{ color: 'var(--text-primary)' }}>
          Cumulative Tax Paid Over Time
        </h3>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={cumulativeTaxData}>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" vertical={false} />
            <XAxis
              dataKey="year"
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
            />
            <YAxis
              tickFormatter={formatCompact}
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
              width={60}
            />
            <Tooltip content={<CustomTooltip />} />
            <Legend
              iconType="line"
              iconSize={12}
              wrapperStyle={{ fontSize: '11px', paddingTop: '16px' }}
            />
            {comparison.strategies.map(strategy => (
              <Line
                key={strategy.id}
                type="monotone"
                dataKey={strategy.label}
                stroke={STRATEGY_COLORS[strategy.id]}
                strokeWidth={strategy.id === winner?.id ? 3 : 2}
                dot={{ fill: STRATEGY_COLORS[strategy.id], r: 3, strokeWidth: 0 }}
              />
            ))}
          </LineChart>
        </ResponsiveContainer>
      </div>
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/charts/ComparisonCharts.tsx
git commit -m "feat: add CumulativeTaxLineChart to ComparisonCharts

- Shows tax burden accumulation over planning horizon
- Lower line = better (less tax paid)
- Winner highlighted with thicker stroke
- Completes 3-chart comparison suite"
```

---

### Task 4.4: Create CompareAllTab Component

**Files:**
- Create: `src/components/tabs/CompareAllTab.tsx`

**Step 1: Create component**

```typescript
// Create src/components/tabs/CompareAllTab.tsx

import { memo } from 'react';
import type { ComparisonResult } from '../../lib/strategyComparison';
import { StrategyComparison } from '../StrategyComparison';
import { ComparisonCharts } from '../charts/ComparisonCharts';

interface CompareAllTabProps {
  comparison: ComparisonResult;
}

export const CompareAllTab = memo(function CompareAllTab({
  comparison,
}: CompareAllTabProps) {
  return (
    <div className="space-y-6">
      {/* Existing 3-column strategy cards */}
      <StrategyComparison comparison={comparison} />

      {/* Visual Comparison Charts */}
      <div>
        <h3 className="font-semibold text-lg mb-4" style={{ color: 'var(--text-primary)' }}>
          Visual Comparison
        </h3>
        <ComparisonCharts comparison={comparison} />
      </div>
    </div>
  );
});
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/tabs/CompareAllTab.tsx
git commit -m "feat: create CompareAllTab component

- Reuses existing StrategyComparison 3-column cards
- Adds ComparisonCharts for visual trajectory analysis
- Tab 2 - validates the recommendation with side-by-side comparison"
```

---

## Phase 5: Tab 3 - Details Components

### Task 5.1: Create DetailedCharts Component (TaxBreakdownStackedBar)

**Files:**
- Create: `src/components/charts/DetailedCharts.tsx`

**Step 1: Create component with first chart**

```typescript
// Create src/components/charts/DetailedCharts.tsx

import { memo } from 'react';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';
import type { ComparisonResult } from '../../lib/strategyComparison';
import { formatCurrency } from '../../lib/formatters';

interface DetailedChartsProps {
  comparison: ComparisonResult;
}

const STRATEGY_COLORS: Record<string, string> = {
  'salary-at-ympe': '#3b82f6',
  'dividends-only': '#10b981',
  'dynamic': '#f59e0b',
};

const TAX_COLORS = {
  personal: '#6366f1',
  corporate: '#f59e0b',
  cpp: '#ec4899',
  ei: '#8b5cf6',
  qpip: '#06b6d4',
  health: '#10b981',
};

const CustomTooltip = ({ active, payload, label }: any) => {
  if (!active || !payload || !payload.length) return null;

  return (
    <div
      style={{
        background: 'rgba(22, 22, 30, 0.95)',
        backdropFilter: 'blur(12px)',
        border: '1px solid rgba(255,255,255,0.1)',
        borderRadius: '12px',
        padding: '12px 16px',
      }}
    >
      <p style={{ fontWeight: 600, marginBottom: 8, color: 'rgba(255,255,255,0.9)' }}>
        {label}
      </p>
      {payload.map((entry: any, index: number) => (
        <div
          key={index}
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: 8,
            marginBottom: 4,
            fontSize: '13px',
          }}
        >
          <span style={{ width: 8, height: 8, borderRadius: '50%', background: entry.color }} />
          <span style={{ color: 'rgba(255,255,255,0.6)' }}>{entry.name}:</span>
          <span style={{ fontWeight: 600, color: 'rgba(255,255,255,0.95)' }}>
            {formatCurrency(entry.value)}
          </span>
        </div>
      ))}
    </div>
  );
};

export const DetailedCharts = memo(function DetailedCharts({
  comparison,
}: DetailedChartsProps) {
  const formatCompact = (value: number): string => {
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value}`;
  };

  // Tax Breakdown Stacked Bar Data
  const taxBreakdownData = comparison.strategies.map(strategy => {
    const totalPersonal = strategy.summary.yearlyResults.reduce((sum, y) => sum + y.personalTax, 0);
    const totalCorporate = strategy.summary.yearlyResults.reduce((sum, y) => sum + y.corporateTax, 0);
    const totalCPP = strategy.summary.yearlyResults.reduce((sum, y) => sum + y.cpp + y.cpp2, 0);
    const totalEI = strategy.summary.yearlyResults.reduce((sum, y) => sum + y.ei, 0);
    const totalQPIP = strategy.summary.yearlyResults.reduce((sum, y) => sum + y.qpip, 0);
    const totalHealth = strategy.summary.yearlyResults.reduce((sum, y) => sum + y.healthPremium, 0);

    return {
      name: strategy.label,
      'Personal Tax': totalPersonal,
      'Corporate Tax': totalCorporate,
      'CPP': totalCPP,
      'EI': totalEI,
      'QPIP': totalQPIP,
      'Health Premium': totalHealth,
    };
  });

  return (
    <div className="space-y-6">
      {/* Tax Breakdown by Strategy */}
      <div className="glass-card p-5">
        <h3 className="font-semibold mb-5" style={{ color: 'var(--text-primary)' }}>
          Tax Breakdown by Strategy
        </h3>
        <ResponsiveContainer width="100%" height={350}>
          <BarChart data={taxBreakdownData} barCategoryGap="30%">
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" vertical={false} />
            <XAxis
              dataKey="name"
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
            />
            <YAxis
              tickFormatter={formatCompact}
              stroke="rgba(255,255,255,0.4)"
              fontSize={11}
              tickLine={false}
              axisLine={false}
              width={60}
            />
            <Tooltip content={<CustomTooltip />} />
            <Legend
              iconType="circle"
              iconSize={8}
              wrapperStyle={{ fontSize: '11px', paddingTop: '16px' }}
            />
            <Bar dataKey="Personal Tax" stackId="a" fill={TAX_COLORS.personal} />
            <Bar dataKey="Corporate Tax" stackId="a" fill={TAX_COLORS.corporate} />
            <Bar dataKey="CPP" stackId="a" fill={TAX_COLORS.cpp} />
            <Bar dataKey="EI" stackId="a" fill={TAX_COLORS.ei} />
            <Bar dataKey="QPIP" stackId="a" fill={TAX_COLORS.qpip} />
            <Bar dataKey="Health Premium" stackId="a" fill={TAX_COLORS.health} radius={[8, 8, 0, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
});
```

**Step 2: Verify builds**

Run: `npm run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/charts/DetailedCharts.tsx
git commit -m "feat: create DetailedCharts with TaxBreakdownStackedBar

- Stacked bar chart showing where tax dollars go
- 6 tax components: personal, corporate, CPP, EI, QPIP, health
- Side-by-side comparison of 3 strategies
- First chart for Details tab"
```

---

Due to length constraints, I'll continue with a summary of remaining tasks. The full plan would continue with:

**Phase 5 (continued):**
- Task 5.2: Add CompensationMixStackedBar
- Task 5.3: Add RRSPRoomBarChart
- Task 5.4: Add IPPContributionsLineChart (conditional)
- Task 5.5: Add EffectiveTaxRateLineChart
- Task 5.6: Create DetailsTab component

**Phase 6: Tab 4 - Export**
- Task 6.1: Create ExportTab component (wrapper for existing components)

**Phase 7: Summary Refactor**
- Task 7.1: Refactor Summary.tsx to use tabs
- Task 7.2: Add tab state management
- Task 7.3: Wire up all tabs with comparison data

**Phase 8: Integration & Polish**
- Task 8.1: Test full tab flow
- Task 8.2: Responsive testing (mobile/tablet)
- Task 8.3: Keyboard navigation testing
- Task 8.4: Update MEMORY.md

Let me save this partial plan and ask about scope:
