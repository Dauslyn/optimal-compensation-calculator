# v3.4 Form Overhaul Design

## Goal

Replace the single long-form with a wizard-first experience for new users, restructure the full form into logical sections, add multi-debt support, and expand IPP to cover both "considering" and "already have one" modes. All changes are UI + engine depth — no changes to the core compensation calculation logic.

---

## Architecture

### Entry flow

```
First visit (no localStorage)
  → Wizard (7 steps)
  → Results page
  → "Edit inputs" → Full sectioned form

Returning visit (localStorage exists)
  → Full sectioned form with last session pre-loaded
  → Results page

"Start over" button
  → Clears localStorage
  → Relaunches wizard
```

Wizard completion writes to the same `UserInputs` state the full form uses. No separate data model. Wizard is a new component `src/components/wizard/SetupWizard.tsx` that orchestrates step components. Full form remains `InputFormClean.tsx`, restructured.

---

## Part 1: Setup Wizard

### Component structure

```
src/components/wizard/
  SetupWizard.tsx          — orchestrator: step state, progress bar, Back/Next/Skip nav
  steps/
    Step1AboutYou.tsx
    Step2YourPractice.tsx
    Step3Retirement.tsx
    Step4Investments.tsx
    Step5Debts.tsx         — skippable
    Step6IPP.tsx           — skippable
    Step7Spouse.tsx        — skippable
```

### Navigation

- Progress bar at top: 7 dots or labelled steps
- **Back** — always available from step 2+
- **Next** — enabled when required fields are filled
- **Skip** — available on steps 5, 6, 7
- **Skip remaining** — on step 5+, jumps straight to results with defaults for remaining steps
- Keyboard: Enter advances, Escape does nothing (no accidental close)

### Wizard steps

**Step 1 — About You** (required)
- Province (select)
- Current age (number)
- Retirement age (number)

**Step 2 — Your Practice** (required)
- Required after-tax income ($ input)
- Corporate investment balance ($ input, tooltip: "Current value of investments held inside your corporation")
- Annual corporate net income ($ input, tooltip: "Profit retained in the corporation after expenses, before owner compensation")

**Step 3 — Retirement** (required)
- Retirement spending target ($ input) — "How much do you want to spend per year in retirement, in today's dollars?"
- Lifetime objective (select: Maximize retirement spending / Maximize estate / Balanced)
- CPP start age (number, default 65)
- OAS eligible (checkbox, default true)
- OAS start age (number, default 65, shown only if OAS eligible)

**Step 4 — Investments** (required, but has good defaults)
- Asset allocation: 4 sliders (Canadian Equity, US Equity, International Equity, Fixed Income) — must sum to 100%, live validation
- Blended expected return shown read-only, updates as sliders move
- Helper text: "Not sure? Leave the defaults — they reflect a balanced growth portfolio."

**Step 5 — Debts** (skippable)
- "Do you have any debts?" toggle
- If yes: debt rows (see Part 3)
- Skip button: "I'll add this later"

**Step 6 — IPP** (skippable)
- "Are you considering or do you have an Individual Pension Plan (IPP)?" toggle
- If yes: IPP mode toggle + fields (see Part 4)
- Skip button: "I'll add this later"

**Step 7 — Spouse / Second Shareholder** (skippable)
- "Include a spouse or second shareholder?" toggle
- If yes: spouse income ($), current age, retirement age, RRSP room, TFSA room
- Skip button: "We'll skip this for now"

---

## Part 2: Full Form Restructure

### Section inventory (9 sections, replacing 8)

Delete the "Inflation & Indexing" ghost section. Its explanatory text moves to the tooltip on the Expected Inflation Rate field in Basic Information.

**1. Basic Information** — expanded by default
- Province
- Required after-tax income
- Corporate investment balance
- Annual corporate net income
- Current age
- Retirement age
- *Advanced toggle (⚙ Advanced settings — styled pill button, not grey text):*
  - Planning end age
  - Starting year (2025 / 2026)
  - Expected inflation rate
  - Inflate spending needs (checkbox)

**2. Retirement & Government Benefits** — expanded by default *(new section, fields pulled from Basic Advanced)*
- Retirement spending target
- Lifetime objective (select)
- CPP start age
- Age started earning (for CPP calculation)
- Average historical salary (for CPP calculation)
- OAS eligible (checkbox)
- OAS start age

**3. Portfolio Composition** — expanded by default *(unchanged)*
- 4 allocation inputs
- Blended return (read-only)
- *Advanced toggle:* per-asset-class return overrides

**4. RRSP & TFSA** — collapsed by default *(new section, pulled from Basic Advanced and Strategy Advanced)*
- Available RRSP room
- Actual RRSP balance
- Contribute to RRSP (checkbox)
- Available TFSA room
- Actual TFSA balance
- Maximize TFSA (checkbox)

**5. Compensation Strategy** — collapsed by default *(restructured)*
- Strategy description text: "Default: Dynamic Optimizer…"
- *Advanced toggle:*
  - Salary strategy (select: dynamic / fixed / dividends-only)
  - Fixed salary amount (conditional on fixed)

**6. Notional Account Balances** — collapsed by default *(unchanged)*
- Info text
- *Advanced toggle:* CDA, GRIP, eRDTOH, nRDTOH

**7. Debts** — collapsed by default *(expanded to multi-debt, see Part 3)*

**8. IPP Analysis** — collapsed by default *(expanded, see Part 4)*

**9. Spouse / Second Shareholder** — collapsed by default *(unchanged structurally)*

### Advanced toggle redesign

Replace the current small grey `AdvancedToggle` button with a visually distinct pill button:

```tsx
// Before (easy to miss)
<button className="text-xs text-muted">Advanced settings ▾</button>

// After (visible)
<button className="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium border"
  style={{ borderColor: 'var(--border-default)', color: 'var(--text-secondary)' }}>
  <SettingsIcon size={12} />
  {open ? 'Hide advanced' : 'Advanced settings'}
</button>
```

---

## Part 3: Multi-Debt Support

### Data model

Replace `UserInputs` single-debt fields with an array:

```typescript
// Current (to remove)
includeDebt: boolean
totalDebtAmount: number
annualDebtPayment: number
debtInterestRate: number

// New
debts: DebtEntry[]

interface DebtEntry {
  id: string          // uuid, for React keys
  label: string       // "Mortgage", "Clinic LOC", etc.
  balance: number     // current outstanding balance
  paymentAmount: number
  paymentFrequency: 'weekly' | 'biweekly' | 'semi-monthly' | 'monthly' | 'annually'
  interestRate: number  // decimal, e.g. 0.055
}
```

### Payment frequency multipliers

```typescript
const FREQUENCY_MULTIPLIERS = {
  weekly: 52,
  biweekly: 26,
  'semi-monthly': 24,
  monthly: 12,
  annually: 1,
}

// Annual payment = paymentAmount × FREQUENCY_MULTIPLIERS[paymentFrequency]
```

### Engine impact

The calculator currently uses `totalDebtAmount`, `annualDebtPayment`, `debtInterestRate` as scalars. New engine adapter:

```typescript
function aggregateDebts(debts: DebtEntry[]): {
  totalBalance: number
  totalAnnualPayment: number
  weightedInterestRate: number  // balance-weighted average
} {
  const totalBalance = debts.reduce((s, d) => s + d.balance, 0)
  const totalAnnualPayment = debts.reduce((s, d) =>
    s + d.paymentAmount * FREQUENCY_MULTIPLIERS[d.paymentFrequency], 0)
  const weightedInterestRate = totalBalance > 0
    ? debts.reduce((s, d) => s + d.interestRate * d.balance, 0) / totalBalance
    : 0
  return { totalBalance, totalAnnualPayment, weightedInterestRate }
}
```

This adapter is called before passing to the existing calculator — no changes to `calculator.ts` internals.

### UI

```
[ + Add a debt ]

Mortgage          Balance: $450,000   $2,800 / month   @ 5.5%   [×]
Clinic LOC        Balance: $85,000    $500   / month   @ 7.2%   [×]

[ + Add a debt ]
```

- "Add a debt" button appends a new empty row
- × removes the row (no confirmation needed)
- Label field is free text, placeholder suggestions: "Mortgage", "Line of Credit", "Student Loan", "Car Loan"
- Payment frequency is a select dropdown (not free text)
- No maximum rows

### Share link + localStorage

`debts` array serializes as a compact array in share links. Backwards compatible: old share links with single-debt fields deserialize into a single `DebtEntry`.

---

## Part 4: IPP Expansion

### Data model additions to UserInputs

```typescript
// Existing (keep)
considerIPP: boolean
ippAge: number
ippYearsOfService: number

// New
ippMode: 'considering' | 'existing'    // default: 'considering'
ippBest3AvgSalary?: number             // default: uses requiredIncome as proxy
ippPastServiceYears?: number           // years of service credited before IPP setup
ippExistingFundBalance?: number        // current FMV of IPP fund (existing mode only)
ippLastValuationYear?: number          // year of last actuarial valuation
ippLastValuationLiability?: number     // actuarial liability from last valuation report
ippLastValuationAnnualContribution?: number  // annual CSC from last valuation report
```

### Engine additions (src/lib/tax/ipp.ts)

New exported functions:

```typescript
// DB limit table — extend existing IPP_LIMITS with annuity factor
const ANNUITY_FACTOR_AT_65 = 12.5  // approximate, 1983 GAM with 3% post-retirement indexing

// Pension entitlement
export function calculateProjectedPension(
  yearsOfService: number,         // total including past service
  best3AvgSalary: number,
  retirementYear: number,
): number {
  const dbLimit = IPP_LIMITS[retirementYear]?.maxPensionableBenefit ?? IPP_LIMITS[2026].maxPensionableBenefit
  const unitPension = Math.min(0.02 * best3AvgSalary, dbLimit)
  return unitPension * yearsOfService
}

// Target liability roll-forward (between valuations)
export function estimateCurrentTargetLiability(
  lastValuationLiability: number,
  lastValuationYear: number,
  annualCSC: number,
  currentYear: number,
): number {
  const yearsElapsed = currentYear - lastValuationYear
  const liabilityGrown = lastValuationLiability * Math.pow(1.075, yearsElapsed)
  // Add CSC contributions compounded at mid-year
  const cscAccumulated = annualCSC * ((Math.pow(1.075, yearsElapsed) - 1) / 0.075)
  return liabilityGrown + cscAccumulated
}

// Funding gap/surplus
export function calculateFundingStatus(
  currentFundFMV: number,
  estimatedTargetLiability: number,
): {
  gap: number          // positive = deficiency (need more contributions)
  surplus: number      // positive = surplus
  fundingRatio: number
  contributionHolidayTriggered: boolean  // fund > 1.25× liability
}

// Terminal funding estimate at retirement
export function estimateTerminalFunding(
  projectedFundAtRetirement: number,
  projectedAnnualPension: number,
): number {
  const annuityCost = projectedAnnualPension * ANNUITY_FACTOR_AT_65
  return Math.max(0, annuityCost - projectedFundAtRetirement)
}
```

### UI — IPP section

**"Considering" mode** (default when `considerIPP` is checked):

```
Age: [45]    Years of service: [12]    Best 3-yr avg salary: [$220,000] (optional, defaults to income)

── Engine outputs (read-only display cards) ──────────────────────────
Estimated annual contribution    $38,400/yr     vs RRSP room: $31,780/yr
Break-even vs RRSP               Age 43 ✓ (already past)
Projected pension at retirement  $67,200/yr
Admin costs (est.)               $2,500–$4,000/yr
──────────────────────────────────────────────────────────────────────
```

**"Already have one" mode** (shown when `ippMode === 'existing'`):

```
Current fund balance (FMV):          [$485,000]
Last actuarial valuation year:       [2023]
Actuarial liability from that report: [$510,000]
Annual contribution (from report):   [$36,000]
Past service years credited:         [8]         (years before IPP was set up)
Best 3-yr average T4 salary:         [$220,000]  (optional)

── Engine outputs ────────────────────────────────────────────────────
Estimated current target liability   $580,000
Current fund (FMV)                   $485,000
Funding gap                          $95,000  ⚠ Deficiency likely at next valuation
Projected pension at retirement      $94,400/yr (30 yrs × $3,147/yr)
Terminal funding room                ~$380,000 additional deductible room at retirement
──────────────────────────────────────────────────────────────────────

ℹ These are planning estimates. Formal funding status is determined by your actuary
  at the next triennial valuation.
```

Toggle between modes: radio buttons or tab — "Considering an IPP" / "Already have one"

Spouse IPP section: same two-mode structure, nested under spouse IPP checkbox (unchanged from current).

---

## Part 5: What Doesn't Change

- All core compensation calculation logic in `calculator.ts`
- Strategy comparison (`runStrategyComparison`)
- Monte Carlo simulation
- Results tabs (Recommended, Compare All, Details, Dashboard, Export)
- Share link structure (additive changes only — new fields get new compact keys)
- localStorage auto-save
- PDF export / accountant report

---

## Open Questions Resolved

| Question | Decision |
|---|---|
| Multiple debts | Unlimited add/remove rows |
| Debt input | Payment amount + frequency dropdown (weekly/biweekly/semi-monthly/monthly/annual); engine converts to annual |
| IPP existing fund math | Implementable: roll-forward liability at 7.5%, actual fund at user's return rate, gap = deficiency |
| IPP "already have one" for launch | Yes — math is solid, disclaim it's a planning estimate |
| Form structure | Wizard for first-time, full sectioned form after |
| Advanced toggle | Styled pill button with settings icon, replaces invisible grey text |
| Inflation & Indexing section | Delete — tooltip text moves to Expected Inflation Rate field |
| CPP/OAS location | New "Retirement & Government Benefits" section — first-class, not buried |
| RRSP/TFSA | Own section (#4), always visible when collapsed |
