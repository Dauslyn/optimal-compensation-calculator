# v3.2 Design — Portfolio Tax Correctness + UX Overhaul

**Date:** 2026-02-19
**Status:** Approved
**Branch:** main (commit directly, no feature branch)

---

## Overview

Six interconnected improvements that align the tool with its stated purpose: helping Canadian physicians and accountants determine the optimal compensation strategy over a lifetime, measured by retirement income sustainability and net estate value.

The changes fall into two categories:
- **Engine correctness** (Sections 1): Fix capital gains / portfolio return decomposition
- **Presentation** (Sections 2–6): Surface lifetime outcomes, reduce form friction, add narrative synthesis

---

## Section 1 — Capital Gains / Portfolio Return Decomposition Fix

### The Bug

`src/lib/accounts/investmentReturns.ts` line 98:

```typescript
const realizedCapitalGain = totalCapitalGain * 0.5; // 50% realized each year
```

This assumes half of all annual price appreciation is realized as taxable capital gains every year. For a passive index ETF, realized gains from portfolio turnover are ~0.3–0.4% of the portfolio annually (from index rebalancing), not 50% of price appreciation. This causes massive AAII overstatement, making the SBD grind trigger far more aggressively than it should for a buy-and-hold index investor.

### The Fix — Per-Asset-Class Return Decomposition

Replace the single blended `investmentReturnRate` approach with per-asset-class return decomposition using empirically-grounded defaults derived from historical index data.

**Research basis (sources: iShares Canada, Vanguard Canada, PWL Capital, FTSE Russell):**

| Asset Class | Default Expected Return | Canadian Dividends | Foreign Income | Annual Realized CG (ETF turnover) | Unrealized CG |
|---|---|---|---|---|---|
| Canadian Equity (TSX) | 8.5% | 2.8% of balance | 0% | 0.3% of balance | remainder |
| US Equity (S&P 500) | 9.5% | 0% | 1.5% of balance | 0.3% of balance | remainder |
| International Equity (EAFE) | 7.0% | 0% | 3.0% of balance | 0.4% of balance | remainder |
| Fixed Income (CDN Bonds) | 4.0% | 0% | 0% (all interest) | 0% | 0% |

**Why these numbers:**
- TSX dividend yield: historical average 2.5–3.0%, using 2.8% (mid-range, XIC-based)
- S&P 500 foreign income: ~1.5% (2010–2024 average dividend yield); treated as foreign income (no DTC inside CCPC)
- EAFE foreign income: ~3.0% (structurally higher European/Australian yields; XEF/IEFA data)
- ETF turnover realized CG: 0.3–0.4% of balance (cap-weighted passive funds, near-zero due to in-kind creation/redemption mechanism)
- Fixed income: 100% interest income, zero structural capital gain over a full rate cycle

**Blended return:** The weighted average of per-class returns replaces `investmentReturnRate` as the default. Users can still override the blended rate in advanced mode, or set per-class returns individually.

**Capital gains inclusion rate:** 50% (confirmed current law — proposed 66.67% increase was cancelled March 21, 2025). No toggle needed.

**US withholding tax on foreign dividends (15%):**
Per CRA s.126(1) / s.129(3): US withholding is creditable against Part I tax, but the FTC simultaneously reduces the nRDTOH addition. Net effect: 15% withholding on US/international dividends is a permanent cost, not recoverable through RDTOH. Model as: `nRDTOH addition = (foreignIncome × 0.3067) - foreignWithholding`, where `foreignWithholding = foreignDividends × 0.15`.

### Changes Required

**`src/lib/accounts/investmentReturns.ts`:**
- Replace hardcoded dividend yields with the research-grounded defaults above
- Replace `realizedCapitalGain = totalCapitalGain * 0.5` with `realizedCapitalGain = corporateBalance * (weightedTurnoverCGRate)` where turnover rate is ~0.003–0.004 depending on allocation
- `unrealizedCapitalGain = totalCapitalGain - realizedCapitalGain` (remainder, not taxed until disposition)
- Add foreign withholding reduction to nRDTOH calculation

**`src/lib/types.ts`:**
- Add optional per-asset-class return rate overrides to `UserInputs`:
  ```typescript
  canadianEquityReturnRate?: number;   // defaults to 0.085
  usEquityReturnRate?: number;         // defaults to 0.095
  internationalEquityReturnRate?: number; // defaults to 0.070
  fixedIncomeReturnRate?: number;      // defaults to 0.040
  ```
- Keep `investmentReturnRate` as the computed blended rate (read-only in advanced UI, shown as derived value)

**`src/components/InputFormClean.tsx`:**
- Portfolio section advanced toggle reveals per-class return overrides
- Blended return displayed as computed read-only field (so users see the result of their allocation)

### Test Coverage

- Update `investmentReturns` unit tests to verify:
  - TSX-only portfolio: realizedCG ≈ 0.3% of balance (not 50% of price appreciation)
  - 100% bond portfolio: zero capital gains, all interest
  - US equity: foreign income ≈ 1.5% of balance, nRDTOH reduced by withholding
  - AAII for $1M corp with 60% equity / 40% bond: confirm grind doesn't trigger at current passive income levels for a typical physician ($500k SBD limit grind threshold = $50k AAII)

---

## Section 2 — Primary Recommendation: Lifetime Winner as Headline

### The Problem

`bestOverall` (60% tax + 40% corporate balance over accumulation phase) drives the Recommended tab. This ignores retirement entirely, which is the whole point of v3.0+.

### The Fix

When lifetime data is present (always true in v3.0+), `lifetimeWinner.byObjective` becomes the primary recommendation signal.

**`runStrategyComparison()` change:** `winner.bestOverall` remains computed (backward compat) but the Recommended tab reads `lifetimeWinner.byObjective` as the headline winner.

**Recommended tab restructure (three zones):**

**Zone 1 — The Answer:**
```
"For your goals, [Strategy Name] works best."
Retirement income: $XX,XXX/yr  |  Estate value: $X.XM  |  Success rate: XX%
```
Numbers sourced from: `lifetime.totalLifetimeSpending / retirementYears`, `lifetime.estateValue`, `monteCarloResult.successRate`.

**Zone 2 — Why (narrative synthesis):**
Template-string logic, not AI. Conditional sentences based on which strategy wins and by how much:
- If dynamic wins over dividends-only: "The Dynamic strategy builds $X more RRSP room and reduces lifetime tax by $Y vs. Dividends Only, while maintaining the same corporate balance."
- If dividends-only wins: "With your current corporate balance and investment return, avoiding CPP and salary simplifies your structure and nets more at estate."
- Fallback: neutral summary of the winning strategy's headline metrics.

**Zone 3 — Accumulation Details (existing content, demoted):**
Current strategy comparison cards, tax metrics, corporate balance — moved below the fold, clearly labeled "Accumulation Phase Details."

---

## Section 3 — Monte Carlo: Web Worker + Geometric Mean Fix

### Web Worker

Move `runMonteCarlo()` execution into `src/workers/monteCarlo.worker.ts`. The `DetailsTab` posts `UserInputs` via `postMessage`, receives `MonteCarloResult` when complete.

```typescript
// src/workers/monteCarlo.worker.ts
import { runMonteCarlo } from '../lib/monteCarlo';
self.onmessage = (e) => {
  const result = runMonteCarlo(e.data.inputs, e.data.options);
  self.postMessage(result);
};
```

Vite handles worker bundling via `new Worker(new URL('../workers/monteCarlo.worker.ts', import.meta.url), { type: 'module' })`.

The `DetailsTab` replaces the `setTimeout` pattern with a worker ref. Cleanup on unmount terminates the worker.

### Geometric Mean Bias Fix

Current code samples from arithmetic mean distribution, producing ~0.7%/yr upward bias at σ=0.12.

Fix: convert user's arithmetic mean return to geometric equivalent before sampling:
```typescript
// Geometric mean ≈ arithmetic mean - (σ² / 2)
const geometricMean = arithmeticMean - (returnStdDev ** 2) / 2;
// Sample from geometric mean distribution
const sampledReturn = clamp(geometricMean + randn() * returnStdDev, -0.40, 0.60);
```

This is the standard log-normal correction. The p50 line will shift down slightly (more accurate), p90 will shift down more (less optimistic). Document the change in code comments.

---

## Section 4 — Quick Mode with Per-Section Advanced Toggles

### Approach

No global mode switch. Each form section has an independent "Advanced" chevron. Users mix-and-match which sections to expand. Default view shows only core inputs.

### Section-by-Section Breakdown

| Section | Always visible (Quick) | Revealed by Advanced toggle |
|---|---|---|
| **Basic** | Province, Required after-tax income, Current age, Retirement age | Planning horizon, Starting year, Target spending, Lifetime objective |
| **Accounts** | Corporate investment balance | RRSP balance, TFSA balance, RRSP room, TFSA room, CDA, eRDTOH, nRDTOH, GRIP |
| **Portfolio** | Portfolio allocation sliders (4 asset classes), computed blended return (read-only) | Per-class return rate overrides, cap gains inclusion rate (informational) |
| **Strategy** | (hidden — defaults to Dynamic) | Strategy selector (dynamic/fixed/dividends-only), fixed salary amount |
| **Retirement** | (shown when retirement age set) | CPP start age, OAS eligibility/start age, historical salary, spouse fields |
| **Spouse** | Toggle "Has spouse?" | All spouse fields (current behavior — no change) |
| **IPP** | Toggle "Consider IPP?" | All IPP fields (current behavior — no change) |

**Default state produces a valid run with:**
- Province
- Required income
- Current age + retirement age
- Corporate balance
- Everything else uses sensible defaults (dynamic strategy, inflation 2%, blended return from allocation, CPP at 65, OAS at 65, 40-year historical salary at $80k)

### Implementation

Add `advancedOpen: Record<SectionName, boolean>` to local form state. Each section header gets a chevron button toggling that section's advanced state. No change to `UserInputs` shape — defaults handle the rest.

The section headers already exist as collapsible panels in `InputFormClean.tsx`. The advanced toggle is a nested expansion within the already-open section.

---

## Section 5 — Narrative Synthesis on Recommended Tab

Covered in Section 2 Zone 2. Template strings only — no external dependencies, no AI calls.

**Template logic (pseudocode):**
```typescript
function buildNarrative(winner, loser, diff): string {
  const taxDiff = formatCurrency(Math.abs(diff.lifetimeTaxDifference));
  const estateDiff = formatCurrency(Math.abs(diff.estateValueDifference));

  if (winner.id === 'dynamic') {
    return `The Dynamic strategy reduces lifetime tax by ${taxDiff} and leaves ${estateDiff} more at estate vs. ${loser.label}, by optimizing salary each year to fill RRSP room without triggering higher brackets.`;
  }
  if (winner.id === 'dividends-only') {
    return `With your corporate balance and return rate, avoiding CPP premiums and RRSP room trades a small tax cost for a larger final estate — Dividends Only leaves ${estateDiff} more than the next-best strategy.`;
  }
  // salary-at-ympe
  return `Maximizing CPP through salary at YMPE builds guaranteed retirement income that reduces reliance on corporate drawdown, producing ${formatCurrency(winner.lifetime.totalLifetimeSpending / retirementYears)}/yr in sustainable retirement spending.`;
}
```

Narrative lives in a new `src/lib/narrativeSynthesis.ts` module, pure functions, fully unit-testable.

---

## Section 6 — "My Current Strategy" as 4th Comparison Slot

When `inputs.salaryStrategy === 'fixed'` and `inputs.fixedSalaryAmount > 0`, the comparison engine adds a 4th strategy entry: **"My Current Setup"** with the user's exact inputs (no overrides). This entry appears in the Compare All tab alongside the three presets.

Diffs are computed against the lifetime winner (not against best-overall), so users see: "Your current setup costs $X more in lifetime tax and leaves $Y less at estate than the recommended strategy."

**`runStrategyComparison()` change:** Check `inputs.salaryStrategy === 'fixed'` at the top; if true, prepend a "current" strategy entry using `inputs` as-is. Mark it with `isCurrentSetup: true` in `StrategyResult` for UI differentiation.

---

## What We're Not Building (YAGNI)

- Management company / inter-corporate dividend structures
- Salary deferral / bonus-averaging timing
- Prescribed rate loans / income splitting
- GIS optimization
- Shareholder loan tracking
- AMT modeling
- Any backend / user accounts

---

## File Touch Map

| File | Change |
|---|---|
| `src/lib/accounts/investmentReturns.ts` | Core return decomposition fix |
| `src/lib/types.ts` | Add per-class return rate overrides to UserInputs |
| `src/lib/strategyComparison.ts` | Lifetime winner as primary; 4th "current" strategy slot |
| `src/lib/narrativeSynthesis.ts` | New — narrative template logic |
| `src/lib/monteCarlo.ts` | Geometric mean fix |
| `src/workers/monteCarlo.worker.ts` | New — Web Worker wrapper |
| `src/components/InputFormClean.tsx` | Per-section advanced toggles; portfolio section update |
| `src/components/tabs/RecommendedTab.tsx` | Lifetime winner headline; three-zone layout |
| `src/components/tabs/DetailsTab.tsx` | Web Worker wiring; remove setTimeout |
| `src/components/tabs/CompareAllTab.tsx` | 4th strategy slot when applicable |
| `src/lib/__tests__/investmentReturns.test.ts` | New — per-class return tests |
| `src/lib/__tests__/narrativeSynthesis.test.ts` | New — narrative template tests |
| `src/lib/__tests__/strategyComparison.test.ts` | Update for lifetime winner + 4th slot |

---

## Success Criteria

1. A portfolio of $1M corporate investments, 60% equity / 40% bonds, does **not** trigger SBD grind (AAII < $50k threshold) — because unrealized gains are not in AAII
2. Monte Carlo p50 line shifts down ~0.7%/yr vs. current (geometric mean correction confirmed)
3. Monte Carlo renders in < 3 seconds (Web Worker, no UI block)
4. A user can get a complete strategy recommendation from 4 inputs (province, income, age, corporate balance) without touching any other field
5. Recommended tab leads with retirement income + estate + success rate, not tax paid + corporate balance
6. When user has a fixed salary set, Compare All shows 4 strategies with diffs vs. lifetime winner
